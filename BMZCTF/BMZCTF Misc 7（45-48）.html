<html>
<head>
  <title>BMZCTF Misc 7（45-48）</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/605894 (zh-CN, DDL); Windows/6.1.1 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="5433"/>
<h1>BMZCTF Misc 7（45-48）</h1>
<h2><a href="https://DemonStarAlgol.github.io/Misc/">[无关链接]</a></h2>

<div>
<span><div><span style="font-weight: bold;">45 可乐加冰</span></div><div><br/></div><div>下载得到png格式文件，十六进制编辑器打开，注意到接近文件尾部分：</div><div><img src="BMZCTF Misc 7（45-48）_files/Image.png" type="image/png" data-filename="Image.png"/></div><div>这一段数据有如下疑点：</div><div>1、看似IDAT块，但根据前一块的长度推算，块标记IDAT前的长度位却只有三位，且为00 00 00；</div><div>2、数据部分开头字节为78 9C，这是zlib压缩数据的文件头；</div><div>3、紧接在这段数据后的IEND块长度块通常应为00 00 00 00。</div><div>因此有理由怀疑，这段数据来自另一个zlib压缩数据，出题人想要将它插入此处伪装成一个正常IDAT块，但是没伪装好。</div><div><br/></div><div>为了提取该zlib压缩数据内容，使用binwalk。这样一来，首先binwalk -e会检测zlib压缩数据的头和尾并将其提取，其次该工具会把提取到的压缩数据全部尝试解压，从而一次操作直接获取解压后内容。记住zlib头78 9C字节的位置0x2AE96，然后：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>root@kali:~/Desktop# binwalk -e data.png</div><div><br/></div><div>DECIMAL       HEXADECIMAL     DESCRIPTION</div><div>--------------------------------------------------------------------------------</div><div>0             0x0             PNG image, 498 x 887, 8-bit/color RGBA, non-interlaced</div><div>91            0x5B            Zlib compressed data, compressed</div><div>175766        0x2AE96         Zlib compressed data, default compression</div></div><div>十六进制编辑器打开获得的2AE96文件：</div><div><img src="BMZCTF Misc 7（45-48）_files/Image [1].png" type="image/png" data-filename="Image.png"/></div><div>可以看到出现了ASCII可打印字符范围以外的字节，但整段数据中只出现了特定的几种字节，似乎存在一定规律。注意到所有字节的十六进制表示形式中均未出现A-F六个数字，尝试将其作为十进制数字ASCII转码：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>f = open('C:/Users/Administrator/Desktop/2AE96', 'rb').read()</div><div>for i in f:</div><div>    print(chr(int(hex(i)[2:])), end='')</div></div><div>输出结果：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>S.$$$_+S.$__$+S.___+S.__$+S.$$$$+S.$$$_+S.$__$+S.__$+&quot;-&quot;+S.$_$$+S.$_$_+S.$$_$+S.$$_+&quot;-&quot;+S.$__+S.$_$_+S.$$$$+S.$$$+&quot;-&quot;+S.$__$+S.$__$+S.$$_+S._$$+&quot;-&quot;+S.$$_$+S.$_$_+S.$$_$+S.$___+S.__$+S._$_+S.$$$$+S.$_$+S.$$_+S._$_+S.$__+S.$$_$</div></div><div><br/></div><div>搜索发现该字符串形式比较类似<a href="https://utf-8.jp/public/jjencode.html">jjencode</a>，一种Javascript代码混淆方式。根据jjencode的特性，将字符串中的S全部替换为$：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>$.$$$_+$.$__$+$.___+$.__$+$.$$$$+$.$$$_+$.$__$+$.__$+&quot;-&quot;+$.$_$$+$.$_$_+$.$$_$+$.$$_+&quot;-&quot;+$.$__+$.$_$_+$.$$$$+$.$$$+&quot;-&quot;+$.$__$+$.$__$+$.$$_+$._$$+&quot;-&quot;+$.$$_$+$.$_$_+$.$$_$+$.$___+$.__$+$._$_+$.$$$$+$.$_$+$.$$_+$._$_+$.$__+$.$$_$</div></div><div>但这段代码还无法直接执行。注意到所有的jjencode混淆工具示例代码都是alert()形式，但直接包上alert()也不行，尝试包上alert()后再进行一次jjencode混淆：</div><div><img src="BMZCTF Misc 7（45-48）_files/Image [2].png" type="image/png" data-filename="Image.png"/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>$=~[];$={___:++$,$$$$:(![]+&quot;&quot;)[$],__$:++$,$_$_:(![]+&quot;&quot;)[$],_$_:++$,$_$$:({}+&quot;&quot;)[$],$$_$:($[$]+&quot;&quot;)[$],_$$:++$,$$$_:(!&quot;&quot;+&quot;&quot;)[$],$__:++$,$_$:++$,$$__:({}+&quot;&quot;)[$],$$_:++$,$$$:++$,$___:++$,$__$:++$};$.$_=($.$_=$+&quot;&quot;)[$.$_$]+($._$=$.$_[$.__$])+($.$$=($.$+&quot;&quot;)[$.__$])+((!$)+&quot;&quot;)[$._$$]+($.__=$.$_[$.$$_])+($.$=(!&quot;&quot;+&quot;&quot;)[$.__$])+($._=(!&quot;&quot;+&quot;&quot;)[$._$_])+$.$_[$.$_$]+$.__+$._$+$.$;$.$$=$.$+(!&quot;&quot;+&quot;&quot;)[$._$$]+$.__+$._+$.$+$.$$;$.$=($.___)[$.$_][$.$_];$.$($.$($.$$+&quot;\&quot;&quot;+$.$_$_+(![]+&quot;&quot;)[$._$_]+$.$$$_+&quot;\\&quot;+$.__$+$.$$_+$._$_+$.__+&quot;($.$$$_+$.$__$+$.___+$.__$+$.$$$$+$.$$$_+$.$__$+$.__$+\\\&quot;-\\\&quot;+$.$_$$+$.$_$_+$.$$_$+$.$$_+\\\&quot;-\\\&quot;+$.$__+$.$_$_+$.$$$$+$.$$$+\\\&quot;-\\\&quot;+$.$__$+$.$__$+$.$$_+$._$$+\\\&quot;-\\\&quot;+$.$$_$+$.$_$_+$.$$_$+$.$___+$.__$+$._$_+$.$$$$+$.$_$+$.$$_+$._$_+$.$__+$.$$_$\\&quot;+$.$__+$.___+&quot;);&quot;+&quot;\&quot;&quot;)())();</div></div><div>控制台运行：</div><div><img src="BMZCTF Misc 7（45-48）_files/Image [3].png" type="image/png" data-filename="Image.png"/></div><div>得到flag。</div><div><br/></div><div>flag：BMZCTF{e901fe91-bad6-4af7-9963-dad812f5624d}</div><div><br/></div><div><span style="font-weight: bold;">46 SDNISC2020_简单js</span></div><div><br/></div><div>下载得到js格式文件，文本编辑器打开看一下：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>/**</div><div>* Pseudo md5 hash function</div><div>* @param {string} string</div><div>* @param {string} method The function method, can be 'ENCRYPT' or 'DECRYPT'</div><div>* @return {string}</div><div>*/</div><div>function pseudoHash(string, method) {</div><div>  // Default method is encryption</div><div>  if (!('ENCRYPT' == method || 'DECRYPT' == method)) {</div><div>    method = 'ENCRYPT';</div><div>  }</div><div>  // Run algorithm with the right method</div><div>  if ('ENCRYPT' == method) {</div><div>    // Variable for output string</div><div>    var output = '';</div><div>    // Algorithm to encrypt</div><div>    for (var x = 0, y = string.length, charCode, hexCode; x &lt; y; ++x) {</div><div>      charCode = string.charCodeAt(x);</div><div>      if (128 &gt; charCode) {</div><div>        charCode += 128;</div><div>      } else if (127 &lt; charCode) {</div><div>        charCode -= 128;</div><div>      }</div><div>      charCode = 255 - charCode;</div><div>      hexCode = charCode.toString(16);</div><div>      if (2 &gt; hexCode.length) {</div><div>        hexCode = '0' + hexCode;</div><div>      }</div><div>      </div><div>      output += hexCode;</div><div>      </div><div>    }</div><div>    // Return output</div><div><br/></div><div>    return output;</div><div>  } else if ('DECRYPT' == method) {</div><div>    // DECODE MISS</div><div>    // Return ASCII value of character</div><div>    return string;</div><div>  }</div><div>}</div><div>document.getElementById('password').value = pseudoHash('19131e18041b1d4c47191d19194f1949481a481a1d4c1c461b4d484b191b4e474f1e4b1d4c02', 'DECRYPT');</div></div><div>虽然不懂Javascript，但大致能看出来加密流程是这样：</div><div>1、把字符转码为数字；</div><div>2、数字大于等于128则减去128，小于128则加上128；</div><div>3、用255减去上述数字，再转十六进制输出。</div><div><br/></div><div>尝试反向解密：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>s = '19131e18041b1d4c47191d19194f1949481a481a1d4c1c461b4d484b191b4e474f1e4b1d4c02'</div><div><br/></div><div>for i in range(0, len(s), 2):</div><div>    n = 255 - int(s[i: i+2], 16)</div><div>    if n &gt;= 128:</div><div>        n -= 128</div><div>    else:</div><div>        n += 128</div><div>    print(chr(n), end='')</div></div><div>运行得到flag。</div><div><br/></div><div>flag：flag{db38fbff0f67e7eb3c9d274fd180a4b3}</div><div><br/></div><div><span style="font-weight: bold;">47 掘地三尺</span></div><div><br/></div><div>下载到doc格式文件，长这样：</div><div><img src="BMZCTF Misc 7（45-48）_files/Image [4].png" type="image/png" data-filename="Image.png"/></div><div>右键-字体-取消隐藏，变成了这样：</div><div><img src="BMZCTF Misc 7（45-48）_files/Image [5].png" type="image/png" data-filename="Image.png"/></div><div>注意到一大串回车之后有两行的回车位置不对劲，说明这两行应该是有内容的，选中之后改一下字体颜色：</div><div><img src="BMZCTF Misc 7（45-48）_files/Image [6].png" type="image/png" data-filename="Image.png"/></div><div>得到第一段flag：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>flag{real_</div></div><div><br/></div><div>接下来看下面一块有奇怪的红色和黑色线条的地方，红色是因为Word标记了拼写错误，黑色可能是换行符。总之这一段也是有内容的，直接复制出来（顺带一提，从上一行行末开始复制就不会导致前面一部分文字丢失）：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>FF D8 FF E0 00 10 4A 46 49 46 00 01 01 01 00 60</div><div>00 60 00 00 FF DB 00 43 00 08 06 06 07 06 05 08</div><div>07 07 07 09 09 08 0A 0C 14 0D 0C 0B 0B 0C 19 12</div><div>……（后略）</div></div><div>大量十六进制数字，很明显是某张JPG格式图片字节数据的十六进制形式，将其转为图片：</div><div><img src="BMZCTF Misc 7（45-48）_files/1.jpg" type="image/jpeg" data-filename="1.jpg"/></div><div>同时发现文件尾有额外数据：</div><div><img src="BMZCTF Misc 7（45-48）_files/Image [7].png" type="image/png" data-filename="Image.png"/></div><div>根据提示，把图片高度改为106：</div><div><img src="BMZCTF Misc 7（45-48）_files/1 [1].jpg" type="image/jpeg" data-filename="1.jpg"/></div><div>得到第二段flag：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>_deep_</div></div><div><br/></div><div>Stegsolve查看修改高度后的图片，在R/G/B Plane的低位发现大量马赛克状色块：</div><div><img src="BMZCTF Misc 7（45-48）_files/Image [8].png" type="image/png" data-filename="Image.png"/></div><div>虽然JPG格式是有损压缩，但这里在纯白色背景区域远离黑色文字的8x8小块中也出现了色差，不能排除使用了隐写工具的可能性。尝试后发现steghide有嫌疑，但需要密码：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>D:\CTFToolkit-v1.1.0\信息隐藏\steghide&gt;steghide.exe info C:\Users\Administrator\</div><div>Desktop\1.jpg</div><div>&quot;1.jpg&quot;:</div><div>  format: jpeg</div><div>  capacity: 244.0 Byte</div><div>Try to get information about embedded data ? (y/n) y</div><div>Enter passphrase:</div><div>steghide: could not extract any data with that passphrase!</div></div><div>那就看看能不能爆破密码，借用一下大佬的脚本：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div># -*- coding: utf8 -*-</div><div>#author:pcat</div><div>#http://pcat.cnblogs.com</div><div>from subprocess import *</div><div><br/></div><div>def foo():</div><div>    stegoFile='1.jpg'</div><div>    extractFile='hide.txt'</div><div>    passFile='/usr/share/wordlists/rockyou.txt'</div><div><br/></div><div>    errors=['could not extract','steghide --help','Syntax error']</div><div>    cmdFormat='steghide extract -sf &quot;%s&quot; -xf &quot;%s&quot; -p &quot;%s&quot;'</div><div>    f=open(passFile,'r')</div><div><br/></div><div>    for line in f.readlines():</div><div>        cmd=cmdFormat %(stegoFile,extractFile,line.strip())</div><div>        p=Popen(cmd,shell=True,stdout=PIPE,stderr=STDOUT)</div><div>        content=unicode(p.stdout.read(),'gbk')</div><div>        for err in errors:</div><div>            if err in content:</div><div>                break</div><div>        else:</div><div>            print content,</div><div>            print 'the passphrase is %s' %(line.strip())</div><div>            f.close()</div><div>            return</div><div><br/></div><div>if __name__ == '__main__':</div><div>    foo()</div><div>    print 'ok'</div><div>    pass</div></div><div>在Linux下用Python2运行：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>root@kali:~/Desktop# python SHbrute.py</div><div>wrote extracted data to &quot;hide.txt&quot;.</div><div>the passphrase is password</div><div>ok</div></div><div>隐写内容：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>doc}</div></div><div><br/></div><div>flag：flag{real_deep_doc}</div><div><br/></div><div><span style="font-weight: bold;">48 SDNISC2020_RSA</span></div><div><br/></div><div>为什么RSA加密会放在Misc分类里……</div><div><br/></div><div>下载得到txt格式文件，内容是RSA加密的几个参数：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>n = 0xa1d4d377001f1b8d5b2740514ce699b49dc8a02f12df9a960e80e2a6ee13b7a97d9f508721e3dd7a6842c24ab25ab87d1132358de7c6c4cee3fb3ec9b7fd873626bd0251d16912de1f0f1a2bba52b082339113ad1a262121db31db9ee1bf9f26023182acce8f84612bfeb075803cf610f27b7b16147f7d29cc3fd463df7ea31ca860d59aae5506479c76206603de54044e7b778e21082c4c4da795d39dc2b9c0589e577a773133c89fa8e3a4bd047b8e7d6da0d9a0d8a3c1a3607ce983deb350e1c649725cccb0e9d756fc3107dd4352aa18c45a65bab7772a4c5aef7020a1e67e6085cc125d9fc042d96489a08d885f448ece8f7f254067dfff0c4e72a63557L</div><div>e1 = 0xf4c1158fL</div><div>c1 = 12051796366524088489284445109295502686341498426965277230069915294159131976231473789977279364263965099422235647723775278060569378071469131866368399394772898224166518089593340803913798327451963589996734323497943301819051718709807518655868569656941242449109980876397661605271517459716669684900920279597477446629607627693769738733623143693170696779851882404994923673483971528314806130892416509854017091137325195201225617407959645788145876202882024723106204183257094755002924708009138560347432552090905489132135154932987521239299578509008290614398700799670928805692609756924823628055245227290288940649158862576448537833423L</div><div>e2 = 0xf493f7d1L</div><div>c2 = 16648382384980770705624348910895797622774711113202207693584907182552301186239613809347201161450012615995859738410661452438496756353485538305614949211776668793864984429696790944750894691957799234264508530084026894611228513698963347402329109838109621609770406925700520983387811451074838470370044678634099202003480925903267508744006195455234025325060817223813858985074720872124168142943926467694676717713503559007112874381750005406371400109962943508349497151148446064846096531445037416174913915923050332242843403926133165817310272633884358263778516770288515592959832151762499526363131801945163501999337808208074381212795L</div></div><div>有两组c、e，且n、m相同的情况，套一下脚本：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>import gmpy2 as gp</div><div><br/></div><div>def egcd(a, b):</div><div>    if a == 0:</div><div>        return (b, 0, 1)</div><div>    else:</div><div>        g, y, x = egcd(b % a, a)</div><div>        return (g, x - (b // a) * y, y)</div><div><br/></div><div>n =</div><div>c1 =</div><div>c2 =</div><div>e1 =</div><div>e2 =</div><div><br/></div><div>s = egcd(e1, e2)</div><div>s1 = s[1]</div><div>s2 = s[2]</div><div>if s1 &lt; 0:</div><div>    s1 = - s1</div><div>    c1 = gp.invert(c1, n)</div><div>elif s2 &lt; 0:</div><div>    s2 = - s2</div><div>    c2 = gp.invert(c2, n)</div><div><br/></div><div>m = pow(c1, s1, n) * pow(c2, s2, n) % n</div><div><br/></div><div>from Crypto.Util.number import long_to_bytes</div><div>print(long_to_bytes(m))</div></div><div>运行得到flag。</div><div><br/></div><div>flag：flag{8c16c91be3f3287ff5a10167e922b33b}</div></span>
</div></body></html> 