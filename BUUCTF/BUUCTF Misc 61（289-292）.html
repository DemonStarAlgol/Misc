<html>
<head>
  <title>BUUCTF Misc 61（289-292）</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/605894 (zh-CN, DDL); Windows/6.1.1 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="658"/>
<h1>BUUCTF Misc 61（289-292）</h1>
<h2><a href="https://DemonStarAlgol.github.io/Misc/">[无关链接]</a></h2>

<div>
<span><div><span style="font-weight: bold;">289 [BSidesCF 2019]CRust</span></div><div>题目：This binary is running on . Can you read /home/ctf/flag.txt from it?</div><div>（顺带一提这题名字写错了，是BsidesSF）</div><div><br/></div><div>下载得到crust。这是一个ELF可执行程序，运行后会启动一个DNS查询服务，监听53535端口：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>root@kali:~/Desktop# ./crust</div><div>Server started!</div></div><div>新开一个shell窗口，用dig命令访问本地的53535端口，并发送base32加密后的文件路径，即可返回一系列IP形式的结果。</div><div>例如查询/etc/passwd：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>root@kali:~/Desktop# dig @localhost -p 53535 -t A F5SXIYZPOBQXG43XMQ</div><div><br/></div><div>; &lt;&lt;&gt;&gt; DiG 9.16.2-Debian &lt;&lt;&gt;&gt; @localhost -p 53535 -t A F5SXIYZPOBQXG43XMQ</div><div>; (2 servers found)</div><div>;; global options: +cmd</div><div>;; Got answer:</div><div>;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 37386</div><div>;; flags: qr aa; QUERY: 0, ANSWER: 255, AUTHORITY: 0, ADDITIONAL: 0</div><div><br/></div><div>;; ANSWER SECTION:</div><div>F5SXIYZPOBQXG43XMQ.     231000  IN      A       143.151.131.221</div><div>F5SXIYZPOBQXG43XMQ.     253229  IN      A       58.210.139.156</div><div>F5SXIYZPOBQXG43XMQ.     109163  IN      A       74.4.3.103</div><div>F5SXIYZPOBQXG43XMQ.     59001   IN      A       58.73.84.84</div><div>F5SXIYZPOBQXG43XMQ.     149044  IN      A       233.250.242.252</div><div>F5SXIYZPOBQXG43XMQ.     65038   IN      A       93.40.47.123</div><div>F5SXIYZPOBQXG43XMQ.     155001  IN      A       178.161.227.161</div><div>F5SXIYZPOBQXG43XMQ.     105032  IN      A       84.11.0.7</div><div>F5SXIYZPOBQXG43XMQ.     181     IN      A       87.97.99.104</div><div>……（后略）</div></div><div>通过尝试可知，这些IP形式的数据通过如下方式生成：</div><div>1、将文件内容分为3个字符一组，并记录每组字符的序号；</div><div>2、确定每组的异或密钥，并通过 TTL 列给出， TTL // 1000 即可得到密钥；</div><div>3、进行加密，每一组的序号和3个字符的ASCII值依次与密钥逐位异或，得到4个数字；</div><div>4、将每组生成的4个数字组合成IP形式，并打乱每组顺序输出。</div><div>据此可以写出解密脚本：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>f = open('C:/Users/Administrator/Desktop/ip.txt', 'r').readlines()</div><div><br/></div><div>for line in f:</div><div>    TTL = line.split('     ')[1].split(' ')[0]</div><div>    key = int(TTL) // 1000</div><div>    IP = line.split('A       ')[1].split('.')</div><div>    print(key ^ int(IP[0]), end = ' ')</div><div>    for i in range(1, 4):</div><div>        print(repr(chr(key ^ int(IP[i]))), end = ' ')</div><div>    print('')</div></div><div>输出结果：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>104 'p' 'd' ':'</div><div>199 '/' 'v' 'a'</div><div>39 'i' 'n' '\n'</div><div>1 'r' 'o' 'o'</div><div>124 'o' 'g' 'i'</div><div>28 'i' 'n' ':'</div><div>41 ':' 'x' ':'</div><div>61 'b' 'i' 'n'</div><div>87 'a' 'c' 'h'</div><div>……（后略）</div></div><div>从而可以通过每组的序号和字符还原出全部文件内容。</div><div><br/></div><div>然后加上获取数据和还原文件的部分，得到本地可以打通的完整脚本如下（需要先另外开shell窗口运行crust）：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>import os</div><div>import base64</div><div><br/></div><div>addr = '@localhost'</div><div>port = '53535'</div><div>path_o = '/root/Desktop/flag.txt'</div><div>path = str(base64.b32encode(path_o.encode('utf-8')), encoding = 'utf-8').replace('=', '')</div><div><br/></div><div>cmd = 'dig ' + addr + ' -p ' + port + ' -t A ' + path + '| grep ' + path + '&gt; res.txt'</div><div>os.system(cmd)</div><div><br/></div><div>f = open('res.txt', 'r').readlines()[1:]</div><div>data = [''] * len(f) * 3</div><div><br/></div><div>for line in f:</div><div>    line = line.replace(' ', '').replace('\t', '').replace(path + '.', '')</div><div>    TTL = line.split('INA')[0]</div><div>    key = int(TTL) // 1000</div><div>    IP = line.split('INA')[1].split('.')</div><div>    num = key ^ int(IP[0])</div><div>    for i in range(1, 4):</div><div>        data[num * 3 + i - 4] = chr(key ^ int(IP[i]))</div><div>print(''.join(data))</div></div><div><br/></div><div>然后把地址和端口换成靶机的，文件路径换成题目给出的：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>import os</div><div>import base64</div><div><br/></div><div>addr = '@node3.buuoj.cn' <font color="#FF0000"># 注意这个@很重要</font></div><div>port = '27901'</div><div>path_o = '/home/ctf/flag.txt'</div><div>path = str(base64.b32encode(path_o.encode('utf-8')), encoding = 'utf-8').replace('=', '')</div><div><br/></div><div>cmd = 'dig ' + addr + ' -p ' + port + ' -t A ' + path + '| grep ' + path + '&gt; res.txt'</div><div>os.system(cmd)</div><div><br/></div><div>f = open('res.txt', 'r').readlines()[1:]</div><div>data = [''] * len(f) * 3</div><div><br/></div><div>for line in f:</div><div>    line = line.replace(' ', '').replace('\t', '').replace(path + '.', '')</div><div>    TTL = line.split('INA')[0]</div><div>    key = int(TTL) // 1000</div><div>    IP = line.split('INA')[1].split('.')</div><div>    num = key ^ int(IP[0])</div><div>    for i in range(1, 4):</div><div>        data[num * 3 + i - 4] = chr(key ^ int(IP[i]))</div><div>print(''.join(data))</div></div><div>运行得到flag：</div><div><img src="BUUCTF Misc 61（289-292）_files/Image.png" type="image/png" data-filename="Image.png" width="709"/></div><div><br/></div><div>flag：本题是动态flag，每次生成靶机flag都不一样……</div><div><br/></div><div><span style="font-weight: bold;">290 [WMCTF2020]行为艺术</span></div><div><br/></div><div>下载得到png格式文件。Linux下查看提示CRC错误，Windows下可正常显示，说明高度被修改过。爆破正确高度：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>import struct</div><div>import binascii</div><div>from Crypto.Util.number import bytes_to_long</div><div><br/></div><div>img = open('C:/Users/Administrator/Desktop/attachment.png', 'rb').read()</div><div><br/></div><div>for i in range(0xFFFF):</div><div>    stream = img[12:20] + struct.pack('&gt;i', i) + img[24:29]</div><div>    crc = binascii.crc32(stream)</div><div>    if crc == bytes_to_long(img[29:33]):</div><div>        print(hex(i))</div></div><div>结果为0x284。用十六进制编辑器修改高度后得到：</div><div><img src="BUUCTF Misc 61（289-292）_files/attachment.png" type="image/png" data-filename="attachment.png" width="896"/></div><div>明显是一个zip压缩包的十六进制数据，用不同的奇特字体转成了图片。一般来说应该用图像识别算法来识别，但是这里长度比较短，说不定肉眼识别会快一点：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>504B0304140000000800DB93C55086A3</div><div>9007D8000000DF01000008000000666C</div><div>61672E74787475504B0E823010DD9370</div><div>8771DDCCB0270D5BBD0371815A9148AC</div><div>6951C2ED9D271F89C62E2693D7F76BB7</div><div>DE9FC80D2E6E68E782A326D2E01F81CE</div><div>6D55E76972E9BA7BCCB3ACEF7B89F7B6</div><div>E90EA16A6EE2439D45179ECDD1C5CCFB</div><div>6B9AA489C1218C92B898779D765FCCBB</div><div>58CC920B6662C5F91749931132258F32</div><div>BBA7C288C5AE103133106608409DAC41</div><div>9F77241A3412907814AB7A922106B8DE</div><div>D0D25AEC8A634929025C46A33FE5A1D3</div><div>167A100323B1ABEE4A7A0708413A19E1</div><div>7718165F5D3E73D577798E36D5144B66</div><div>315AAE315078F5E51A29246AF402504B</div><div>01021F00140009000800DB93C55086A3</div><div>9007D8000000DF010000080024000000</div><div>000000002000000000000000666C6167</div><div>2E7478740A0020000000000001001800</div><div>4A0A9A64243BD601F9D8AB39243BD601</div><div>2D00CA13223BD601504B050600000000</div><div>010001005A000000FE00000000000000</div></div><div>用十六进制编辑器保存为zip格式文件。附件中还给了个hint，MD5是<span style="font-size: unset; color: unset; font-family: unset;">17f5b08342cf65f6dc08ed0b4c9bd334。对照一下发现完全一致，说明肉眼识别没有出错。打开压缩包发现有加密，先判断是否伪加密：</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>D:\CTFToolkit-v1.1.0\暴力破解\ZipCenOp&gt;java -jar ZipCenOp.jar r 1.zip</div><div>success 1 flag(s) found</div></div><div>成功解压得到flag.txt：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>Good eyes! Here is your flag:</div><div>https://www.splitbrain.org/services/ook</div><div><br/></div><div>+++++ ++++[ -&gt;+++ +++++ +&lt;]&gt;+ +++++ .&lt;+++ [-&gt;-- -&lt;]&gt;- .&lt;+++ [-&gt;-- -&lt;]&gt;-</div><div>.&lt;+++ +[-&gt;+ +++&lt;] &gt;+.&lt;+ ++[-&gt; ---&lt;] &gt;---- -.&lt;++ +++++ [-&gt;++ +++++ &lt;]&gt;++</div><div>++.-- --.&lt;+ +++[- &gt;---- &lt;]&gt;-- ----. +++++ +++.&lt; +++[- &gt;---&lt; ]&gt;-.+ ++.++</div><div>+++++ .&lt;+++ [-&gt;-- -&lt;]&gt;- .+++. -.... --.++ +.&lt;++ +[-&gt;+ ++&lt;]&gt; ++++. &lt;++++</div><div>++++[ -&gt;--- ----- &lt;]&gt;-- ----- ----- --.&lt;+ +++[- &gt;++++ &lt;]&gt;+. +...&lt; +++++</div><div>+++[- &gt;++++ ++++&lt; ]&gt;+++ +++++ +++.. .-.&lt;</div></div><div>显然是Brainfuck，解密得到：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>WMCTF{wai_bi_baaaa_bo!2333~~~}</div></div><div><br/></div><div>flag：WMCTF{wai_bi_baaaa_bo!2333~~~}</div><div><br/></div><div><span style="font-weight: bold;">291 [INSHack2019]Tower of Babel</span></div><div><br/></div><div>下载得到md格式文件和module.dwarf、System.map。前者是题目说明：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>A long time ago, hackers spoke the same language.</div><div>They were able to understand each other easily and they challenged H4x0r, father of all hackers.</div><div>H4x0r, realizing that hackers were conspiring against him, introduced many other languages to divide them.</div><div>Now it's a mess, we need encodings and we always argue about Python 3 being better than Python 2 (or the opposite)...</div><div>H4x0r is still hiding somewhere, waiting to find someone worthy of being told its secret to restore peace in the hacking world.</div><div>Me and my team tracked him down through time and space to finally get stuck on [this](https://static.ctf.insecurity-insa.fr/fc1fb6481ee711d32bcc8b715dc0c7e06b394d50-extra.tar.gz).</div><div>Will you help us find H4x0r and get its secret ?</div></div><div><br/></div><div>然而这个压缩包已经下载不到了，里面似乎是一个内存镜像。先记录一下Writeup：</div><div><a href="https://github.com/InsecurityAsso/inshack-2019/blob/master/tower-of-babel/writeup.md">https://github.com/InsecurityAsso/inshack-2019/blob/master/tower-of-babel/writeup.md</a></div><div><br/></div><div>flag：INSA{83a6ab5f84fba8bcceca59b94946d06c1b4057822b7f789cb0ca2ea2e091dcfc}</div><div><br/></div><div><span style="font-weight: bold;">292 [INSHack2018]Virtual Printer</span></div><div><br/></div><div>下载得到md格式文件：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>Hey !</div><div>Someone did something really smart to retrieve stolen documents.</div><div>Will you find what it's all about?</div><div>https://virtual-printer.ctf.insecurity-insa.fr</div></div><div><br/></div><div>但是这个URL已经打不开了，BUUCTF上也没有搭建靶机。只能先记录一下Writeup：</div><div><a href="https://github.com/seclib/inshack-2018/blob/master/for/virtual-printer/writeup.md">https://github.com/seclib/inshack-2018/blob/master/for/virtual-printer/writeup.md</a></div><div><br/></div><div>flag：INSA{d54137b6928af176453f176c1b5ca9ec022003ede3fcf872a7a1741b09375a38}</div></span>
</div></body></html> 