<html>
<head>
  <title>BUUCTF Misc 58（277-280）</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/605894 (zh-CN, DDL); Windows/6.1.1 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="678"/>
<h1>BUUCTF Misc 58（277-280）</h1>
<h2><a href="https://DemonStarAlgol.github.io/Misc/">[无关链接]</a></h2>

<div>
<span><div><span style="font-weight: bold;">277 [HITCON2018]ev3scanner</span></div><div><br/></div><div>下载得到gz格式文件。建议手动修改扩展名为.tar.gz，解压得到ev3_driving_base.jpg、flag.jpg和pklg格式文件。</div><div><br/></div><div>先看两张图片：</div><div><span style="font-weight: bold;"><img src="BUUCTF Misc 58（277-280）_files/Image.png" type="image/png" data-filename="Image.png" width="1077"/></span></div><div>大致可以看出，这是一个用乐高EV3机器人搭建的带有扫描器的小车。地板上铺有黑白两色的flag图案。小车扫描图案后，所传输的数据被记录在ev3_scanner_record.pklg文件中。</div><div><br/></div><div>参考Writeup：</div><div><a href="https://w0y.at/writeup/2018/10/22/hitcon-2018-ev3-scanner.html">https://w0y.at/writeup/2018/10/22/hitcon-2018-ev3-scanner.html</a></div><div><br/></div><div>flag：hitcon{EV3GYROSUCKS}</div><div><br/></div><div><span style="font-weight: bold;">278 [BSidesSF2020]anagrams</span></div><div><br/></div><div>下载得到txt格式文件，内容为题目说明：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>Check out the BSidesSF CTF program.  We got a chance to put a puzzle in there. If you're good with permutations, you'll get this once.</div></div><div><br/></div><div>怀疑也是一道现场题，在<a href="https://github.com/BSidesSF/ctf-2020-release/tree/master/anagrams">Github</a>上可以找到一些相关文件。从文件内容来看，似乎要从某个地方找到一些英文短语，然后玩anagram得到和黑客、CTF等相关的短语作为答案。<a href="https://zh.wikipedia.org/wiki/%E6%98%93%E4%BD%8D%E6%9E%84%E8%AF%8D%E6%B8%B8%E6%88%8F">anagram</a>是一种英文文字游戏，将一个单词或短句的所有字母打乱顺序，重新排列成另一个单词或短句，如 ATTACH FREE PLUG 易序后可以得到 CAPTURE THE FLAG 。</div><div><br/></div><div>flag：CTF{ONEFORANAGRAMS}</div><div><br/></div><div><span style="font-weight: bold;">279 [INSHack2019]new-authent</span></div><div><br/></div><div>下载得到md格式文件和readme.zip。前者是题目说明：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>Thanks to our new authent mecanism we can not be hacked, indeed we can uniquely identify our printer. Just follow the instructions.</div><div>[Readme](https://static.ctf.insecurity-insa.fr/462f6f63b796b10cf4ff613793bb65930b1e4912.tar.gz)</div><div>`https://new-authent.ctf.insecurity-insa.fr`</div></div><div><br/></div><div>解压readme.zip，得到五个文件。其中readme.md内容为：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div># How to login</div><div><br/></div><div>1) Generate a totp code. The seed is the same 8 digit number than the safe code but base32 encoded (param HMAC-SHA1, 30s steps, 10 bytes secret)</div><div>2) Write it on a new document. It works great with Verdana or Hack, with font size between 60 and 100.</div><div>3) Print it on our printer, it is very important to use our printer as we use the Document Colour Tracking Dots.</div><div>4) Scan the printed document, with at least 300 dpi and save it as a png.</div><div>5) Use the scanned document to login. Sometimes our system does not recognize the result, please try again with another code</div><div><br/></div><div>Note : You can find 2 printed document with their timestamps as filename as example.</div><div>Working remotly ? Might want to take a look at Deda for the printer part ;)</div></div><div>1556512424和1556565272.pdf分别是内容为6位数字的pdf文档。scan_1和scan_2.png看起来是pdf文件的截图。</div><div><br/></div><div>根据readme.md中的说明可以知道，pdf文件的内容是TOTP （Time based One Time Passwords）码，文件名是对应的时间戳。经查询得知，hashcat中有针对TOTP的攻击模式。参考<a href="https://www.unix-ninja.com/p/attacking_google_authenticator">该文章</a>可以用hashcat爆破TOTP，有两点需要注意：</div><div>1、hashcat的<a href="https://hashcat.net/wiki/doku.php?id=example_hashes">example_hashes</a>页面中可以查询到，TOTP模式对应模式应为18100；</div><div>2、题目已经给出安全码为8位数字，爆破时需要加上掩码?d?d?d?d?d?d?d?d。</div><div><br/></div><div>但本题后续步骤还需要连接服务器，而给出的地址似乎已经失效。先记录一下Writeup：</div><div><a href="https://github.com/sirk390/writeups/blob/master/New-Authent.md">https://github.com/sirk390/writeups/blob/master/New-Authent.md</a></div><div><a href="https://github.com/InsecurityAsso/inshack-2019/blob/master/new-authent/writeup.md">https://github.com/InsecurityAsso/inshack-2019/blob/master/new-authent/writeup.md</a></div><div><br/></div><div>flag：INSA{S0rry_4_Th3_B4d_0cR}</div><div><br/></div><div><span style="font-weight: bold;">280 [AIS3 EOF CTF 2019 Quals]Ponzi Scheme</span></div><div><br/></div><div>打开靶机：</div><div><img src="BUUCTF Misc 58（277-280）_files/Image [1].png" type="image/png" data-filename="Image.png" width="884"/></div><div>需要在600秒内计算出答案，令其满足给出的条件：加上特定字符串头后的SHA256值开头22个比特为0。每60秒可以刷新一次字符串头，其他条件不变。由于并未限制答案位数，因此可以仅爆破全部由数字组成的答案。脚本为：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>import hashlib</div><div><br/></div><div>def solve(prefix, difficulty=22):</div><div>    zeros = '0' * difficulty</div><div>    def is_valid(digest):</div><div>        bits = ''.join(bin(i)[2:].zfill(8) for i in digest)</div><div>        return bits[:difficulty] == zeros</div><div>    i = 0</div><div>    while True:</div><div>        i += 1</div><div>        s = prefix + str(i)</div><div>        if is_valid(hashlib.sha256(s.encode()).digest()):</div><div>            return str(i)</div></div><div><br/></div><div>输入答案后进入以下页面：</div><div><img src="BUUCTF Misc 58（277-280）_files/Image [2].png" type="image/png" data-filename="Image.png" width="1159"/></div><div><br/></div><div>和题目名称一样，这是一个庞氏骗局。每个入局者起初有1000元资金，可以选择投资三种计划中的任意一个。每个计划有相应的回报周期和回报率。需要通过进行投资，将资金增加到10000元以上才能获取flag。但基于庞氏骗局的性质，如果诈骗者本人没有收集到足够的资金，是不可能给予入局者回报的。因为必须有足够多的后续入局者，诈骗者才会将他们投入的资金作为回报交给初期的入局者。从而可以得出解法：</div><div>1、初始入局一人，全部资金投入Plan C；</div><div>2、等待一段时间，再入局若干人，全部资金投入Plan C，使诈骗者的资金池足够支付第一名入局者；</div><div>3、控制时间，确保第一名入局者投资1800秒时资金池足够，即其他入局者尚未收回过多资金回报；</div><div>4、第一名入局者收回Plan C的回报，资金达到10000元，获得flag。</div><div><br/></div><div>如果有多人同时尝试解答此题可能造成策略上的变化，但在BUUCTF上靶机是唯一的，不会受到其他人影响。另一方面，每次从靶机首页解答完SHA256爆破问题后，均可以得到一个固定的URL，对应一名入局者。由此可以单机模拟多人入局。</div><div>首先收集足够的URL：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>import requests</div><div>import re</div><div><br/></div><div>host = 'http://cf7f3c89-c0b7-4950-9096-4c32127d60a6.node3.buuoj.cn/'</div><div>urls = []</div><div>s = requests.session()</div><div><br/></div><div>while True:</div><div>    r = s.get(host).text</div><div>    prefix = re.findall('&lt;code&gt;(.*)&lt;/code&gt;', r)[0]</div><div>    u = s.get(host, params=dict(answer = solve(prefix)), allow_redirects = True).url</div><div>    print(u)</div><div>    urls.append(u)</div></div><div><br/></div><div>接下来如下操作：</div><div>1、得到第一个URL后，进入并投资Plan C，然后设置1800秒后的闹钟；</div><div>2、等待5分钟左右（主要是等脚本爆破结果），陆续进入后续得到的URL，并全部投资Plan C；</div><div>3、重复第2步直到闹钟响起，停止爆破，进入第一个URL，收取回报，获得flag。</div><div><br/></div><div>如图，总共投入了18名上当受骗者，其中第一名入局者收取到了回报并得到了flag。</div><div><img src="BUUCTF Misc 58（277-280）_files/Image [3].png" type="image/png" data-filename="Image.png" width="1162"/></div><div>由于本题的特殊性，每次新开靶机都需要较长时间才能获取flag，因此没有测试本题是否动态flag（感觉上很可能是）。根据上述步骤操作可以确保获取到正确flag。</div><div><br/></div><div><span style="font-weight: bold;">思考了一下如果有多人在同一个服务器上竞争操作时的策略：</span></div><div>1、首先仍然由一名入局者（在此情况下基本上不会是整场骗局的第一个入局者，但不影响）投资Plan C；</div><div>2、在该入局者投资1800秒的瞬间必须保证资金池有足够资金用于回报，即资金池必须大于10000元；</div><div>3、由于该入局者自己投入的1000元在1800秒中很可能已经被其他人拿走，考虑最坏情况即资金池为0；</div><div>4、从而需要至少10名新入局者一起投入全部资金，同时要保证这些资金不会被其他人拿走，保留到1800秒为止；</div><div>5、注意到Plan A和B的投资回报周期分别是6秒和90秒，因此越接近1800秒时投资，越有可能保留到1800秒；</div><div>6、但仍无法确保避免以下情形，例如1709秒有人投资Plan B，1798秒左右投入资金会在1799秒时被收取回报；</div><div>7、因此要尽可能增大成功几率，可以在1795秒左右开始，以越多越好的入局者陆续进行投资；</div><div>8、但这也可能让其他参赛者更方便获得flag，因为资金池过大会导致其他人不需要考虑资金池有限的问题；</div><div>9、所以还需要再增加一道自行回收资金池的操作。</div><div><span style="font-weight: bold;">最后的策略是：</span></div><div>1、首先准备3个URL，同时准备好在1800秒内爆破出30个左右新URL，如果来不及则需要提前准备一部分；</div><div>2、0秒，入局者甲进场，全部投资Plan C，1秒，入局者乙和丙进场，全部投资Plan C；</div><div>3、1795秒，其余30名入局者进场，全部投资，建议部分投资Plan A或B以更早削减部分后续资金池；</div><div>4、1800秒，入局者甲收取回报，得到flag；</div><div>5、1801秒，入局者乙和丙收取回报，把30名入局者投入的资金清空，给其他参赛者制造麻烦；</div><div>6、1805和1885秒，若资金池仍有剩余（因为其他参赛者的投入），后续30名入局者会回收一部分，继续制造麻烦；</div><div>7、后续还可以自动进行短线投资来不断削减资金池。</div><div>以上操作可能需要用Python脚本来发送请求，以确保时间尽可能精确，和在短时间内进行大量操作。</div><div><br/></div><div>flag：flag{bdf1216d-949c-4a1a-bde5-a0ec7823ad03}</div><div>（本题可能是动态flag，但每次获取新的flag都要半小时以上，实在没时间试了……）</div></span>
</div></body></html> 