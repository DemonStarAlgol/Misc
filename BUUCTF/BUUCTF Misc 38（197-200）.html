<html>
<head>
  <title>BUUCTF Misc 38（197-200）</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/605894 (zh-CN, DDL); Windows/6.1.1 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1316"/>
<h1>BUUCTF Misc 38（197-200）</h1>
<h2><a href="https://DemonStarAlgol.github.io/Misc/">[无关链接]</a></h2>

<div>
<span><div><span style="font-weight: bold;">197 大流量分析（二）</span></div><div>题目：黑客对A公司发动了攻击，以下是一段时间内获取到的流量包，那黑客使用了哪个邮箱给员工发送了钓鱼邮件?</div><div><br/></div><div>和之前的大流量分析（一）用的是同样的附件。</div><div>根据题目给出的信息，已知有员工收到了钓鱼邮件。邮件一般通过SMTP或POP协议传输，wireshark逐个打开流量包，并过滤这两个协议。查找到<span style="font-weight: bold;">数据采集D_eth0_NS_20160809_171230.pcap</span>包的64645号数据包。</div><div><img src="BUUCTF Misc 38（197-200）_files/Image.png" type="image/png" data-filename="Image.png"/></div><div>追踪TCP流可以得到邮件信息和内容，其中的大部分汉字内容以GB2312编码，部分被base64加密。尝试解密一部分：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>Subject: =?gb2312?B?<font color="#FF0000">z7XNs8n9vLYgx+u087zS16LS4g==</font>?=</div><div>Thread-Topic: =?gb2312?B?<font color="#FF0000">z7XNs8n9vLYgx+u087zS16LS4g==</font>?=</div><div>系统升级 请大家注意</div></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>tPO80rrDoaMNCiAgICAgvPjT2rmry77N+MLnvNy5ubjEtq+jrLK/t9bTptPD0OjSqsn9vLajrL7J</div><div>sOaxvm1haWyhom9hoaJjcm21yM+1zbPW8LK9vavM5ru7o6zH67TzvNK1x8K8aHR0cDovLzExOC4x</div><div>OTQuMTk2LjIzMjo4MDg0L2dldC5waHAgzO7QtNfUvLq1xNXKusXS1LH[14 bytes missing in capture file].by2oaMN</div><div>CiAgICDQu9C7tPO80qOhDQoNCg==</div><div>大家好。</div><div>     鉴于公司网络架构改动，部分应用需要升级，旧版本mail、oa、crm等系统逐步将替换，请大家登录http://118.194.196.232:8084/get.php 填写自己的帐号以（缺失）。</div><div>    谢谢大家！</div></div><div>注意到来源邮箱并非公司内部邮箱，邮件中给出的地址也很可疑，还要求提供账号信息，非常明显的钓鱼邮件。猜测这就是题目要求找到的钓鱼邮件来源，尝试提交后成功。</div><div><br/></div><div>flag：flag{xsser@live.cn}</div><div><br/></div><div><span style="font-weight: bold;">198 [INSHack2019]Passthru</span></div><div><br/></div><div>下载得到md格式文件和passthru.zip。前者是题目说明：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>You're part of a company security team and the admin has recently enabled interception on the company filtering proxy.</div><div>The admin is pretty confident when it comes to its domain whitelist.</div><div>He gave you a （此处为题目下载地址） to review. Time to prove him wrong.</div></div><div><br/></div><div>解压得到capture.pcap和sslkey.log。wireshark打开前者，发现了TLS协议的流量数据。</div><div>编辑-首选项-Protocols-TLS，导入sslkey.log文件，对TLS流量进行解密。</div><div><img src="BUUCTF Misc 38（197-200）_files/Image [1].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>然后查看已解密的TLS流量，先导出HTTP对象：</div><div><img src="BUUCTF Misc 38（197-200）_files/Image [2].png" type="image/png" data-filename="Image.png"/></div><div>注意到每隔一段就有一次访问images.google.com进行图片搜索的记录。任意导出一个，观察其URL：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>searchbyimage%3fimage_url=http%3A%2F%2Frequestbin.net%2Fr%2Fzk2s2ezk%3Fid%3D82290383-7480-487c-b78b-77ac769c56cd%26kcahsni%3D9ef773fe97f56554a3b4&amp;encoded_image=&amp;image_content=&amp;filename=&amp;hl=fr</div></div><div>URL转码：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>searchbyimage?image_url=http://requestbin.net/r/zk2s2ezk?id=82290383-7480-487c-b78b-77ac769c56cd&amp;<font color="#FF0000">kcahsni=9ef773fe97f56554a3b4</font>&amp;encoded_image=&amp;image_content=&amp;filename=&amp;hl=fr</div></div><div>注意到存在奇怪的参数kcahsni（正好是inshack倒过来），正常的图片搜索中不应该包含这一参数。</div><div><br/></div><div>利用文本过滤器功能，提取所有包含kcahsni的HTTP对象，并把该参数的值拼接起来。</div><div><img src="BUUCTF Misc 38（197-200）_files/Image [3].png" type="image/png" data-filename="Image.png"/></div><div>得到：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>9ef773fe97f56554a3b4</div><div>26cd07e1f71df3dcee9f</div><div>1eaf89725ab93968fc52</div><div>f03c0a7d653539616433</div><div>66333861303164636130</div><div>30663937353965366432</div><div>30353331373634326335</div><div>34323166636461643033</div><div>34656265373037376332</div><div>62646464343732627b41</div><div>534e490b3295c3d06c24</div><div>f2a8c7e8936667dbf7fe</div><div>ce28456a0fd24ac21ec6</div><div>a12e3efe4b</div></div><div>尝试十六进制ASCII转码：</div><div><img src="BUUCTF Misc 38（197-200）_files/Image [4].png" type="image/png" data-filename="Image.png"/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>（乱码）}e59ad3f38a01dca00f9759e6d205317642c5421fcdad034ebe7077c2bddd472b{ASNI（乱码）</div></div><div>显然，只需要把中间一段倒序即可得到flag。</div><div><br/></div><div>flag：INSA{b274dddb2c7707ebe430dadcf1245c246713502d6e9579f00acd10a83f3da95e}</div><div><br/></div><div><span style="font-weight: bold;">199 [XMAN2018排位赛]ppap</span></div><div><br/></div><div>下载得到pcap格式文件。wireshark打开，统计-Conversations，发现一个非常大的TCP流：</div><div><img src="BUUCTF Misc 38（197-200）_files/Image [5].png" type="image/png" data-filename="Image.png"/></div><div>Follow Stream，发现一段base64密文：</div><div><img src="BUUCTF Misc 38（197-200）_files/Image [6].png" type="image/png" data-filename="Image.png"/></div><div>从开头看出解码后可能是jpg图片，尝试将其解密，保存为文本文件后运行Linux命令：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>root@kali:~/Desktop# base64 -d 1.txt &gt; 1.jpg</div></div><div>虽然能得到jpg图片，但同时也会报错，这里注意到实际上共有三段base64密文，中间被其他字符隔开了。可以通过把得到的1.jpg再base64加密回去，然后搜索末尾的字符找到分隔点。</div><div><img src="BUUCTF Misc 38（197-200）_files/Image [7].png" type="image/png" data-filename="Image.png"/></div><div>根据开头判断第二段密文解密后是zip压缩包，第三段密文解密后是文本（实际为xml格式文件）。分别保存为文本后用base64命令解密：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>root@kali:~/Desktop# base64 -d 1.txt &gt; 1.jpg</div><div>root@kali:~/Desktop# base64 -d 2.txt &gt; 2.zip</div><div>root@kali:~/Desktop# base64 -d 3.txt &gt; 3.xml</div></div><div>其中2.zip是加密压缩包。<span style="font-size: unset; color: unset; font-family: unset;">1.jpg是100x100大小的灰度图像，却有6.5MB大，非常可疑。尝试foremost分离，得到了总计1003张100x100大小的jpg格式灰度图像。</span></div><div><span style="font-size: unset; color: unset; font-family: unset;">查看3.xml，发现其格式是opencv的</span>Haar Cascade分类器格式，猜测需要利用opencv分类器来筛选所有图片找到下一步的线索。在流量包中的base64密文最后还有一段文字：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>I don't understand, this isn't even a ma-Yarrrr, the booty be buried by that which the map points to! <font style="color: rgb(255, 0, 0);">(no spaces and no caps)</font>Ayy, now I be off. But remember, <font color="#FF0000">the factor of scales be 1.02, and the neighborly sorts be limited to 50</font>! Lastly, if ye sail the seven seas, you do be a pirate!</div></div><div>也即分类时scaling_factor参数为1.02，min_neighbors的值要在50以上。</div><div><br/></div><div>搜到的分类脚本，根据实际情况调整了几个变量和参数：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>import os</div><div>import sys</div><div>import cv2</div><div><br/></div><div># Get all of the pictures</div><div>imgs = os.listdir('jpg')</div><div><br/></div><div># Cascade we'll be using for detection</div><div>cascade = cv2.CascadeClassifier('3.xml')</div><div><br/></div><div># From the clues</div><div>scaling_factor = 1.02</div><div><font color="#FF0000">min_neighbors = 50</font></div><div><br/></div><div>for img_name in imgs:</div><div>    # Load the image and run the cascade</div><div>    img = cv2.imread(os.path.join('jpg', img_name))</div><div>    detect = cascade.detectMultiScale(img, scaling_factor, min_neighbors)</div><div>    if len(detect) &gt; 0:</div><div>        for (x, y, w, h) in detect:</div><div>            # X marks the spot!</div><div>            cv2.line(img, (x, y),     (x + w, y + h), (255, 0, 0), 2)</div><div>            cv2.line(img, (x, y + h), (x + w, y),     (255, 0, 0), 2)</div><div>        # Save the new image</div><div>        cv2.imwrite(os.path.join('detected', img_name), img)</div></div><div>注意要手动建立detected文件夹，当min_neighbors为50时，筛选得到了9张图像。<span style="font-size: unset; color: unset; font-family: unset;">然后不断尝试增加min_neighbors的值，直到65时，筛选结果只剩下1张图像。</span></div><div><img src="BUUCTF Misc 38（197-200）_files/00004739.jpg" type="image/jpeg" data-filename="00004739.jpg"/></div><div>海盗骷髅头翻译成英文是skull and cross bones，根据提示no spaces and no caps，得到压缩包密码为：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>skullandcrossbones</div></div><div>解压得到flag。</div><div><br/></div><div>顺便给出一个非预期解，用Kali自带的rockyou.txt作为字典暴力破解zip压缩包的密码：</div><div><img src="BUUCTF Misc 38（197-200）_files/Image [8].png" type="image/png" data-filename="Image.png"/></div><div>耗时约2秒。</div><div><br/></div><div>flag：flag{b31Ng_4_P1r4tE_1s_4lR1GHT_w1Th_M3}</div><div><br/></div><div><span style="font-weight: bold;">200 [NPUCTF2020]HappyCheckInVerification</span></div><div><br/></div><div>下载得到没有后缀名的文件。十六进制编辑器打开：</div><div><img src="BUUCTF Misc 38（197-200）_files/Image [9].png" type="image/png" data-filename="Image.png"/></div><div>很明显就是把zip压缩包的各个块移动了位置。把50 4B 05 06块移动到结尾，得到加密压缩包：</div><div><img src="BUUCTF Misc 38（197-200）_files/Image [10].png" type="image/png" data-filename="Image.png"/></div><div>Ziperello提示压缩包内加密文件数为0，说明是伪加密，ZipCenOp处理。但到这一步仍然无法正确解压，原因是与块长度对应的部分二进制位还需要进一步修复。010Editor中执行ZIP模板会报错也说明文件结构仍然有误。</div><div><br/></div><div>但既然是伪加密，那就可以直接用binwalk提取。</div><div><img src="BUUCTF Misc 38（197-200）_files/Image [11].png" type="image/png" data-filename="Image.png"/></div><div>得到了GWPI_1.mp4和<span style="font-size: unset; color: unset; font-family: unset;">wklv_lv_iodj.png。后者是个缺少定位符的二维码，补全后扫码：</span></div><div><img src="BUUCTF Misc 38（197-200）_files/wklv_lv_iodj2.png" type="image/png" data-filename="wklv_lv_iodj2.png"/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>flag{this_is_not_flag}三曳所諳陀怯耶南夜缽得醯怯勝數不知喝盧瑟侄盡遠故隸怯薩不娑羯涅冥伊盧耶諳提度奢道盧冥以朋罰所即栗諳蒙集皤夷夜集諳利顛呐寫無怯依奢竟#￥#%E68BBFE4BD9BE68B89E6A0BCE79A84E5A7BFE58ABFE59CA8E69C80E5908E32333333||254333254242254338254342254231254338254345254432254238254643254236254145254239254441254437254234254232254131254236254245253244253244254343254438254330254341254336254435...sadwq#asdsadasf faf$use$dasdasdafafa_$ba##se64$</div></div><div><br/></div><div>分段来看：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>flag{this_is_not_flag}</div></div><div>不是flag。</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>三曳所諳陀怯耶南夜缽得醯怯勝數不知喝盧瑟侄盡遠故隸怯薩不娑羯涅冥伊盧耶諳提度奢道盧冥以朋罰所即栗諳蒙集皤夷夜集諳利顛呐寫無怯依奢竟</div></div><div>加上“佛曰：”后用<a href="http://www.keyfc.net/bbs/tools/tudoucode.aspx">与佛论禅</a>解密，得到：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>说了这不是佛拉格，你还来转？给爷爪巴</div></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>E68BBFE4BD9BE68B89E6A0BCE79A84E5A7BFE58ABFE59CA8E69C80E5908E32333333</div></div><div>十六进制，非ASCII码，尝试UTF-8。粘贴到十六进制编辑器内，保存为txt文件，记事本打开得到：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>拿佛拉格的姿势在最后2333</div></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>254333254242254338254342254231254338254345254432254238254643254236254145254239254441254437254234254232254131254236254245253244253244254343254438254330254341254336254435</div></div><div>十六进制ASCII转码：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>%C3%BB%C8%CB%B1%C8%CE%D2%B8%FC%B6%AE%B9%DA%D7%B4%B2%A1%B6%BE%2D%2D%CC%D8%C0%CA%C6%D5</div></div><div>URL转码成汉字（可以输入到浏览器地址栏，或者干脆去掉%后用上面的方法）：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>没人比我更懂冠状病毒--特朗普</div></div><div><br/></div><div>最后还能看到use base64的字样。接着看mp4文件。是一段黑人抬棺的视频，但在20和30秒附近分别有两段拨号声。用Goldwave将这两段分别提取为wav格式音频。</div><div><img src="BUUCTF Misc 38（197-200）_files/Image [12].png" type="image/png" data-filename="Image.png"/></div><div>然后用dtmf2num识别拨号音。<a href="https://l1near.top/index.php/2020/04/20/33.html">一位大佬的Writeup</a>里提供了截取的音频片段：<a href="https://pan.baidu.com/s/1rqX68BbS1gqlT3lc_OWODw">百度网盘</a>，<span style="font-size: unset; color: unset; font-family: unset;">提取码s27k。</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>E:\dtmf2num&gt;dtmf2num.exe 1.wav</div><div>- DTMF numbers:  44807</div><div><br/></div><div>E:\dtmf2num&gt;dtmf2num.exe 2.wav</div><div>- DTMF numbers:  0885</div></div><div><br/></div><div>后续的部分据说因为需要通过手机短信和微信公众号取得线索，以及音频文件质量问题等原因不一定能正常做了，参考大佬的Writeup简要记录步骤如下：</div><div>1、找出题人要hint得到完整的手机号：XXX18070885；（跟工具识别出来的还不一样……）</div><div>2、发短信到这个手机号得到提示NWPUSEC；</div><div>3、关注NWPUSEC的微信公众号，根据之前得到的use base64提示，发送base64加密的手机号，返回一段音频；</div><div>（同一个Writeup里提供的（比公众号返回的要高清的）音频下载地址：<a href="https://pan.baidu.com/s/1kLp-3e_wZ0UDIiRH7R0MAw">百度网盘</a>，<span style="font-size: unset; color: unset; font-family: unset;">提取码unm8。）</span></div><div><br/></div><div>播放这段音频，发现听起来就像信号，尝试用SSTV转为图像（当然要先把m4a转成wav）：</div><div><img src="BUUCTF Misc 38（197-200）_files/Image [13].png" type="image/png" data-filename="Image.png"/></div><div>然后需要用强大的视力辨认出flag。</div><div><br/></div><div>flag：flag{miSc_ChecK_In_Ver16ied}</div><div>总而言之我觉得这是道社工题。</div></span>
</div></body></html> 