<html>
<head>
  <title>BUUCTF Misc 41（209-212）</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/605894 (zh-CN, DDL); Windows/6.1.1 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="884"/>
<h1>BUUCTF Misc 41（209-212）</h1>
<h2><a href="https://DemonStarAlgol.github.io/Misc/">[无关链接]</a></h2>

<div>
<span><div><span style="font-weight: bold;">209 [UTCTF2020]dns-shell</span></div><div><br/></div><div>下载得到pcap格式文件，wireshark打开。查看协议，TLS协议流量无法解密，根据题目名称，猜测和DNS协议有关。<span style="font-size: unset; color: unset; font-family: unset;">过滤dns协议，逐个数据包查看。</span></div><div><span style="font-size: unset;"><br/></span></div><div><span style="font-size: unset; color: unset; font-family: unset;">43号数据包的Queries分组字节流中包含</span>d2hvYW1pCg==，base64解密得到whoami。</div><div><img src="BUUCTF Misc 41（209-212）_files/Image.png" type="image/png" data-filename="Image.png"/></div><div>44号数据包的Answers分组字节流中包含cm9vdA==，base64解密得到root。</div><div><img src="BUUCTF Misc 41（209-212）_files/Image [1].png" type="image/png" data-filename="Image.png"/></div><div>可以看出这是在利用DNS协议传输base64密文形式命令及返回结果的过程。查看最后的108号数据包，追踪UDP流。</div><div><img src="BUUCTF Misc 41（209-212）_files/Image [2].png" type="image/png" data-filename="Image.png"/></div><div>传输的命令：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>bHMgLWxhCg==</div></div><div>base64解密：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>ls -la</div></div><div>返回的结果：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>dG90YWwgMjUxMgpkcnd4ci14ci14ICAgIDEgcm9vdCAgICAgcm9vdCAgICAgICAgICA0MDk2IE1hciAgNiAwNDo0NCAuCmRyd3hyLXhyLXggICAgMSByb290ICAgICByb290ICAgICAgICAgIDQwOTYgTWFyICA2IDA4OjA5IC4uCi1ydy1yLS1yLS0gICAgMSByb290ICAgICByb290ICAgICAgICAgMTIyODggTWFyICA2IDA0OjQyIC5NYWtlZmlsZS5zd3AKLXJ3LXItLXItLSAgICAxIHJvb3QgICAgIHJvb3QgICAgICAgICAgIDEwNCBNYXIgIDUgMjM6NTAgRG9ja2VyZmlsZQotcnctci0tci0tICAgIDEgcm9vdCAgICAgcm9vdCAgICAgICAgICAgMTE5IE1hciAgNSAyMzo1MCBNYWtlZmlsZQotcnctci0tci0tICAgIDEgcm9vdCAgICAgcm9vdCAgICAgICAgICAgIDI4IE1hciAgNSAyMzo1MCBmbGFnLnR4dAotcnd4ci14ci14ICAgIDEgcm9vdCAgICAgcm9vdCAgICAgICAyNTMzODIzIE1hciAgNiAwNDo0NCBzZXJ2ZXIKLXJ3LXItLXItLSAgICAxIHJvb3QgICAgIHJvb3QgICAgICAgICAgMTY5MyBNYXIgIDUgMjM6NTAgc2VydmVyLmdv</div></div><div>base64解密：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>total 2512</div><div>drwxr-xr-x    1 root     root          4096 Mar  6 04:44 .</div><div>drwxr-xr-x    1 root     root          4096 Mar  6 08:09 ..</div><div>-rw-r--r--    1 root     root         12288 Mar  6 04:42 .Makefile.swp</div><div>-rw-r--r--    1 root     root           104 Mar  5 23:50 Dockerfile</div><div>-rw-r--r--    1 root     root           119 Mar  5 23:50 Makefile</div><div>-rw-r--r--    1 root     root            28 Mar  5 23:50 flag.txt</div><div>-rwxr-xr-x    1 root     root       2533823 Mar  6 04:44 server</div><div>-rw-r--r--    1 root     root          1693 Mar  5 23:50 server.go</div></div><div><br/></div><div>但本题给出的流量包中并没有进行cat flag操作。注意到DNS-Shell操作的目标主机是35.188.185.68，但直接用scapy进行相同查询无效。<span style="font-size: unset; color: unset; font-family: unset;">接下来需要进行在线dig操作，发现该地址是从另一个DNS查询（</span>35.225.16.21<span style="font-size: unset; color: unset; font-family: unset;">）派生的。对主机发送查询请求，得到新地址（</span>3.88.57.227<span style="font-size: unset; color: unset; font-family: unset;">）。最后对新地址进行dig，发送命令：</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>Y2F0IGZsYWcudHh0Cg==（cat flag.txt）</div></div><div>返回：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>dXRmbGFneyRhbDF5X3MzTDFTX3NFNF9kTiR9</div></div><div>base64解码得到flag。</div><div><br/></div><div>flag：utflag{$al1y_s3L1S_sE4_dN$}</div><div><br/></div><div><span style="font-weight: bold;">210 一路到底</span></div><div><br/></div><div>下载得到file文件夹，内含155534个txt文本文件。注意到其中包含start.txt，查看内容：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>20555 : The next is a8242a234560a0d3cf121864ee34d7fb.txt</div></div><div>给出了下一个文件的名称，定位到该文件，查看内容：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>772 : The next is 5d2ecc80d506dc00c6457a2cb6430d54.txt</div></div><div>猜测需要重复这一步骤，查看上一个文件内容，得到下一个文件的文件名，如此循环直到找到flag。</div><div><br/></div><div>写Python脚本进行操作：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>path = 'C:/Users/Administrator/Desktop/files/'</div><div>name = 'start.txt'</div><div><br/></div><div>while name:</div><div>    file_name = path + name</div><div>    f = open(file_name, 'r').read()</div><div>    print(f)</div><div>    name = f.split(' : ')[1].replace('The next is ', '')</div></div><div>执行后一路读取到085ce40f67ff47c4580add735abe92ee.txt，其内容为：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>End !</div></div><div>没有flag的信息，文件名也不是flag。</div><div><br/></div><div>重新考虑之前忽略的线索，显然是每个文件中冒号前的数字。观察这些数字的特征，均为5位以下，最小是0。第一个数字20555，尝试转为十六进制，得到504B；第二个数字772转十六进制得到304。联想到zip格式的文件头50 4B 03 04。</div><div>确定方法为：依次读取每个文件，将内容中开头的数字转为十六进制，最后拼接得到zip格式文件。</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>path = 'C:/Users/Administrator/Desktop/files/'</div><div>name = 'start.txt'</div><div>res = open('C:/Users/Administrator/Desktop/res.txt', 'w')</div><div><br/></div><div>while name:</div><div>    file_name = path + name</div><div>    f = open(file_name, 'r').read()</div><div>    print(f)</div><div>    name = f.split(' : ')[1].replace('The next is ', '')</div><div>    num = f.split(' : ')[0]</div><div>    num = int(num, 10)</div><div>    num_hex = str(hex(num))[2:]</div><div>    num_hex = '0' * (4 - len(num_hex)) + num_hex</div><div>    res.write(num_hex)</div></div><div>输出得到res.txt后，将其内容在十六进制编辑器中保存为zip格式文件。</div><div><img src="BUUCTF Misc 41（209-212）_files/Image [3].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>根据注释提示，开始爆破密码。尝试后发现为小写字母加数字的6位密码：</div><div><img src="BUUCTF Misc 41（209-212）_files/Image [4].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>解压得到png格式文件，直接打开显示损坏。十六进制编辑器查看：</div><div><img src="BUUCTF Misc 41（209-212）_files/Image [5].png" type="image/png" data-filename="Image.png"/></div><div>从文件结构判断实际上是jpg格式，修复文件头为FF D8 FF E0，得到jpg图片。</div><div><img src="BUUCTF Misc 41（209-212）_files/Image [6].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>flag：flag{0c6b489ca956e2fd94dce12be4bf0729}</div><div><br/></div><div><span style="color: rgb(255, 0, 0); font-weight: bold;">211 [NPUCTF2020]回收站</span></div><div><br/></div><div><span style="color: rgb(255, 0, 0);">本题需要下载一个3.5GB大的附件，实在是没时间了。先记录Writeup：</span></div><div><a href="https://shimo.im/docs/6hyIjGkLoRc43JRs" style="color: rgb(255, 0, 0);">https://shimo.im/docs/6hyIjGkLoRc43JRs</a></div><div><br/></div><div><span style="color: rgb(255, 0, 0);">flag：flag{e10adc3949ba59abbe56e057f20f883e}</span></div><div><br/></div><div><span style="font-weight: bold;">212 [RoarCTF2019]davinci_cipher</span></div><div><br/></div><div>下载得到flag.txt和k3y.pcapng。先看flag.txt：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>U+1F643U+1F4B5U+1F33FU+1F3A4U+1F6AAU+1F30FU+1F40EU+1F94BU+1F6ABU+1F606U+1F383U+1F993U+2709U+1F33FU+1F4C2U+2603U+1F449U+1F6E9U+2705U+1F385U+2328U+1F30FU+1F6E9U+1F6A8U+1F923U+1F4A7U+1F383U+1F34DU+1F601U+2139U+1F4C2U+1F6ABU+1F463U+1F600U+1F463U+1F643U+1F3A4U+2328U+1F601U+1F923U+1F3A4U+1F579U+1F451U+1F6AAU+1F374U+1F579U+1F607U+1F374U+1F40EU+2705U+2709U+1F30FU+23E9U+1F40DU+1F6A8U+2600U+1F607U+1F3F9U+1F441U+1F463U+2709U+1F30AU+1F6A8U+2716</div></div><div>查询得知是Unicode编码的emoji表情。根据文件名猜测，怀疑是某种密文，而密钥（key）在k3y.pcapng文件中。</div><div><br/></div><div>wireshark打开k3y.pcapng，观察协议，注意到中途出现了大量USB协议流量。查看分组字节流，猜测是Wacom手写板的绘图数据。</div><div><img src="BUUCTF Misc 41（209-212）_files/Image [7].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>参考<a href="https://shawroot.cc/archives/1122">Writeup</a>，用tshark导出数据：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>root@kali:~/Desktop# tshark -r k3y.pcapng -T fields -e usb.capdata |sed '/^$/d' &gt; usbdata.txt</div><div>（这里的sed命令主要是为了去除空行，用正则表达式匹配空行并替换后再输出。）</div></div><div><img src="BUUCTF Misc 41（209-212）_files/Image [8].png" type="image/png" data-filename="Image.png"/></div><div>注意到数据中包含大量长度为55的行，猜测是绘图时的坐标和压感数据。根据USB协议文档：</div><div><img src="BUUCTF Misc 41（209-212）_files/U028wn.png" type="image/png" data-filename="U028wn.png"/></div><div>X和Y坐标各占两个字节，以小端序储存。观察这些数据，排除掉不发生变化或变化较慢的部分，猜测X和Y坐标分别在3-4字节和6-7字节（每个字节是两位十六进制数）：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>1040<b>2a46</b>00<b>1e3c</b>0000000000000000003f00000000000000000000</div><div>1040<b>2046</b>00<b>0b3c</b>0000000000000000003f00000000000000000000</div><div>1040<b>2546</b>00<b>193c</b>0000000000000000003f00000000000000000000</div></div><div>此外第9个字节是压感：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>1061834e00972800<b>0a</b>0c1afe000000000384308094420810004208</div><div>10617d4e00932800<b>9a</b>0c1afe000000000384308094420810004208</div><div>1061794e008e2800<b>78</b>0d1afe000000000284308094420810004208</div></div><div><br/></div><div>写脚本提取长度为55的行，然后剔除压感为0的行，提取X和Y坐标：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>f = open('usbdata.txt', 'r')</div><div>x = []</div><div>y = []</div><div><br/></div><div>for line in f:</div><div>    if len(line) == 55:</div><div>        if line[16:18] != '00':</div><div>            xx = line[6:8] + line[4:6]</div><div>            x.append(str(int(xx, 16)))</div><div>            yy = line[12:14] + line[10:12]</div><div>            y.append(str(int(yy, 16)))</div></div><div>然后将X和Y坐标输出成gnuplot能够识别的格式（每行一个坐标，X+空格+Y）：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>out = open('out.txt', 'w')</div><div>for i in range(len(x)):</div><div>    out.write(x[i] + ' ' + y[i] + '\n')</div></div><div>再用gnuplot绘图：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>root@kali:~/Desktop# gnuplot</div><div><br/></div><div>        G N U P L O T</div><div>        Version 5.2 patchlevel 8    last modified 2019-12-01</div><div><br/></div><div>        Copyright (C) 1986-1993, 1998, 2004, 2007-2019</div><div>        Thomas Williams, Colin Kelley and many others</div><div><br/></div><div>        gnuplot home:     http://www.gnuplot.info</div><div>        faq, bugs, etc:   type &quot;help FAQ&quot;</div><div>        immediate help:   type &quot;help&quot;  (plot window: hit 'h')</div><div><br/></div><div>Terminal type is now 'qt'</div><div><font color="#FF0000">gnuplot&gt; plot 'out.txt'</font></div><div>qt5ct: using qt5ct plugin</div></div><div><img src="BUUCTF Misc 41（209-212）_files/Image [9].png" type="image/png" data-filename="Image.png"/></div><div>垂直翻转，得到：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>MONA_LISA_IS_A_MAN</div></div><div>根据之前的分析，这应该就是key。</div><div><br/></div><div>返回去看flag.txt中Unicode编码的的emoji，用<a href="https://r12a.github.io/app-conversion/">Unicode code converter</a>来转码。</div><div><img src="BUUCTF Misc 41（209-212）_files/Image [10].png" type="image/png" data-filename="Image.png"/></div><div>根据系统和浏览器不同，有可能部分emoji会无法显示，但可以正常复制。然后用<a href="https://aghorler.github.io/emoji-aes/">emoji-aes</a>解密。</div><div><img src="BUUCTF Misc 41（209-212）_files/Image [11].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>flag：RoarCTF{wm-m0de3n_dav1chi}</div></span>
</div></body></html> 