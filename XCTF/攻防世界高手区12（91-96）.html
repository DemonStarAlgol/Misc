<html>
<head>
  <title>攻防世界高手区12（91-96）</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/605894 (zh-CN, DDL); Windows/6.1.1 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1045"/>
<h1>攻防世界高手区12（91-96）</h1>
<h2><a href="https://DemonStarAlgol.github.io/Misc/">[无关链接]</a></h2>

<div>
<span><div><span style="font-weight: bold;">091 hong</span></div><div><br/></div><div>下载得到hong.mp3，但并不能播放。file命令查看文件类型为data，即没有特殊文件格式。</div><div>尝试foremost分解一下，得到了两个jpg图片：</div><div><img src="攻防世界高手区12（91-96）_files/00000161.jpg" type="image/jpeg" data-filename="00000161.jpg"/></div><div><br/></div><div><img src="攻防世界高手区12（91-96）_files/00000269.jpg" type="image/jpeg" data-filename="00000269.jpg"/></div><div><br/></div><div>flag：BCTF{cute&amp;fat_cats_does_not_like_drinking}</div><div><br/></div><div><span style="font-weight: bold;">092 picture2</span></div><div><br/></div><div>下载得到png文件。</div><div><img src="攻防世界高手区12（91-96）_files/e4103617b4a6476fb7aa8f862f2ee400.png" type="image/png" data-filename="e4103617b4a6476fb7aa8f862f2ee400.png"/></div><div><br/></div><div>十六进制编辑器打开，可以看到实际是个jpg图片。查找jpg文件尾FF D9，发现文件尾后还有数据：</div><div><img src="攻防世界高手区12（91-96）_files/Image.png" type="image/png" data-filename="Image.png"/></div><div>把这段数据提取之后保存，在Linux下用file命令判断其类型：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>root@kali:~/Desktop# file 1</div><div>1: zlib compressed data</div></div><div>binwalk -e提取该文件，得到了一个文本文件：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>S1ADBBQAAQAAADkwl0xs4x98WgAAAE4AAAAEAAAAY29kZePegfAPrkdnhMG2gb86/AHHpS0GMqCrR9s21bP43SqmesL+oQGo50ljz4zIctqxIsTHV25+1mTE7vFc9gl5IUif7f1/rHIpHql7nqKPb+2M6nRLuwhU8mb/w1BLAQI/ABQAAQAAADkwl0xs4x98WgAAAE4AAAAEACQAAAAAAAAAIAAAAAAAAABjb2RlCgAgAAAAAAABABgAAFvDg4Xa0wE8gAmth9rTATyACa2H2tMBUEsFBgAAAAABAAEAVgAAAHwAAADcAFtQeXRob24gMi43XQ0KPj4+IKh9qH2ofQ0KDQpUcmFjZWJhY2sgKG1vc3QgcmVjZW50IGNhbGwgbGFzdCk6DQogIEZpbGUgIjxweXNoZWxsIzA+IiwgbGluZSAxLCBpbiA8bW9kdWxlPg0KICAgIKh9qH2ofQ0KWmVyb0RpdmlzaW9uRXJyb3I6IKh9qH2ofah9qH2ofah9qH2ofah9qH2ofah9qH2ofah9qH2ofah9qH2ofah9qH2ofah9qH2ofah9qH2ofSA8LSBwYXNzd29yZCA7KQ0KPj4+IAA=</div></div><div>比较明显是base64，尝试解码：</div><div><img src="攻防世界高手区12（91-96）_files/Image [1].png" type="image/png" data-filename="Image.png"/></div><div>很明显的zip文件头，但开头的PK被调换了位置。在Linux下base64解码并保存为文件：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>root@kali:~/Desktop# echo 密文字符串 | base64 -d &gt; 1.zip</div></div><div>然后十六进制编辑器修复1.zip，打开发现需要密码：</div><div><img src="攻防世界高手区12（91-96）_files/Image [2].png" type="image/png" data-filename="Image.png"/></div><div>从注释里得到提示，密码是Python2.7的零除数报错信息。</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>C:\Users\Administrator\Desktop&gt;python2</div><div>Python 2.7.18 (v2.7.18:8d21aa21f2, Apr 20 2020, 13:25:05) [MSC v.1500 64 bit (AMD64)] on win32</div><div>Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.</div><div>&gt;&gt;&gt; 1/0</div><div>Traceback (most recent call last):</div><div>  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</div><div>ZeroDivisionError: integer division or modulo by zero</div><div>&gt;&gt;&gt;</div></div><div>密码是integer division or modulo by zero。解压后打开code文件：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>begin 644 key.txt</div><div>G0TE30TY[,C,X.$%&amp;,C@Y,T5&quot;.#5%0C%&quot;-#,Y04)&amp;1C8Q-S,Q.49]</div><div>`</div><div>end</div></div><div>多次尝试发现是uuencode：</div><div><img src="攻防世界高手区12（91-96）_files/Image [3].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>flag：CISCN{2388AF2893EB85EB1B439ABFF617319F}</div><div><br/></div><div><span style="font-weight: bold;">093 funny_video</span></div><div><br/></div><div>下载得到mkv文件。MKVToolNix打开发现有两段音频：</div><div><img src="攻防世界高手区12（91-96）_files/Image [4].png" type="image/png" data-filename="Image.png"/></div><div>将两段音频分别提取为mp3格式，用audacity打开，切换到频谱图：</div><div><img src="攻防世界高手区12（91-96）_files/Image [5].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>flag：flag{fun_v1d30_mu51c}</div><div><br/></div><div><span style="font-weight: bold;">094 clemency</span></div><div><br/></div><div>下载得到clemency.bin和flag.enc文件。</div><div>查询得知<a href="https://blog.legitbs.net/2017/07/the-clemency-architecture.html">cLEMENCy</a>（the LEgitbs Middle ENdian Computer architecture）是DEF CON 25主办方Legitimate Business Syndicate设计，在这次比赛中首次出现的一种新型程序架构，特征是：1个字节包含9个比特位，寄存器宽度为3字节，采取中端序储存（即Register XXYYZZ → Memory YYXXZZ，<span style="font-size: unset; color: unset; font-family: unset;">Register XXYY → Memory YYXX）。</span></div><div><span style="font-size: unset;"><br/></span></div><div>本题附件中clemency.bin是用该架构写成的程序，可以通过<a href="https://blog.legitbs.net/2017/07/the-clemency-architecture.html">官方页面</a>提供的模拟器运行，内容是将输入的flag按照该架构的9 Bit形式输出为flag.enc。<span style="font-size: unset; color: unset; font-family: unset;">用IDA的</span><a href="https://github.com/cseagle/ida_clemency" style="font-size: unset; font-family: unset;">clemency反编译插件</a><span style="font-size: unset; color: unset; font-family: unset;">可以直接打开flag.enc得到flag。</span></div><div><span style="font-size: unset; color: unset; font-family: unset;">按照github页面说明，将四个文件放置到对应位置（IDA 7.0 Pro不知道为什么使用插件会报错，IDA 6.6 Pro汉化版可以正常使用）。然后打开flag.enc，选择Loader和Processor type：</span></div><div><img src="攻防世界高手区12（91-96）_files/Image [6].png" type="image/png" data-filename="Image.png"/></div><div><span style="font-size: unset; color: unset; font-family: unset;">IDA会根据反汇编脚本自动进行字节和端序转换，然后将flag.enc中的cLEMENCy架构数据转为正常字符串：</span></div><div><img src="攻防世界高手区12（91-96）_files/Image [7].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>flag：{I_love_cLEMENCy,so_I_want_to_share_it_with_you}</div><div><br/></div><div><span style="font-weight: bold;">095 pyHAHA</span></div><div><br/></div><div>下载得到pyc文件。无法运行，无法反编译。十六进制编辑器打开：</div><div><img src="攻防世界高手区12（91-96）_files/Image [8].png" type="image/png" data-filename="Image.png"/></div><div>注意到galf和3pm.elbissoP tI maerD是很明显的逆向文本。把整个文件逆序一下：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>a = open('C:/Users/Administrator/Desktop/PyHaHa.pyc', 'rb').read()</div><div>b = open('C:/Users/Administrator/Desktop/HaGePiA.pyc', 'wb')</div><div>b.write(a[: : -1])</div></div><div>打开逆序后的文件，末尾很明显有zip压缩包：</div><div><img src="攻防世界高手区12（91-96）_files/Image [9].png" type="image/png" data-filename="Image.png"/></div><div>提取出来。压缩包内包含mp3文件，有注释，且是伪加密，用ZipCenOp处理后解压。</div><div><img src="攻防世界高手区12（91-96）_files/Image [10].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>猜测mp3文件中存在隐写，最后查到需要用DeEgger Embedder（大哥你不说谁想得到这种工具啊）：</div><div><img src="攻防世界高手区12（91-96）_files/Image [11].png" type="image/png" data-filename="Image.png"/></div><div>解出Dream It Possible - extracted.txt，前几行内容：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>JEQGQYLWMUQHG4DFNZ2CA3LPON2CA33GEBWXSIDMNFTGKIDBOMQGCICEMVWW6Y3SMF2AV===</div><div>JEQHEZLDMVXHI3DZEBUGC5TFEBZWKZLOEBTGS5BAORXSAZTPNRWG65ZAMFXG65DIMVZCAY3POVZHGZJAJEQGEZLMNFSXMZJAORUGC5BAORUGKIDJONZXKZLTEBRW63TGOJXW45DJNZTSA5LTEBRXE33TOMQHAYLSOR4SA3DJNZSXGICON53QV===</div><div>N5XGKIDTNFSGKIDJNYQHI2DJOMQGGYLNOBQWSZ3OEBUGC4ZAMJSWK3RAORSWY3DJNZTSA5LTBJ======</div><div>K5SSA2DBOZSSAMJVEBRGS3DMNFXW4IDEN5WGYYLSOMQGS3RAM5XWYZBANFXCA33VOIQHI4TFMFZXK4TZEB3WKIDEN5XCO5BAN53W4IDBNYQG65LOMNSSARTPOJSWSZ3OEBSG63DMMFZCAY3MMFUW24ZAMFZGKIBSG4ZSAYTJNRWGS33OEBSG63DMMFZHGIAK</div><div>ORUGC5BAORUGKIDJONZXKZLTEBXWMIDUNBUXGIDFNRSWG5DJN5XAV===</div></div><div>看到这种情况就联想到base64隐写，如果把部分末尾带有等号=的行解密后再加密，尾部字母也确实存在差异。不同点在于这里的密文都是base32。写个脚本处理一下，规则为：</div><div>1、尾部没有=的行不参与编码；</div><div>2、解密后再加密没有差异的行编码为0；</div><div>3、解密后再加密存在差异的行编码为1。</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>import base64</div><div>a = open('C:/Users/Administrator/Desktop/Dream It Possible - extracted.txt', 'r')</div><div><br/></div><div>data = ''</div><div>for i in a.readlines():</div><div>    i = i[:-1]</div><div>    tmp = base64.b32encode(base64.b32decode(i))</div><div>    tmp = str(tmp)[2:-1]</div><div>    if i[len(i) - 1] == '=':</div><div>        if tmp == i:</div><div>            data += '0'</div><div>        else:</div><div>            data += '1'</div><div>print(data)</div></div><div>输出：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111001111111101111111111111111111011111111101111111111111111000000000000001111111111111110000000000000001111111111111110110001011101001111111111111100111101111111100111111111111101111001111111111111111111111110001111111111111111111111111110011111111111111111111111111111101111111111111111111111111111111111111111111111111111111111111111111111101111111111111100111111111111101111111111111101111111111111101111111111111100000000000000001111111111111100000000000000001111111111111111110111011101101111111111111111111111111111100111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111110111000011111111111111111111100010000001111111111111111111101010011001111111111111111111001010110101111111111111111111011100111101111111111111111111001101111001111111111111111111100101011011111111111111111111100000000001111111111111111111111000100001111111111111111111111111110010111111111111111111111111111111111111111111111111111111111100011111111111111111110000100000011111111111111111100000010011001111111111111111011011010010101111111111111111001111000011101111111111111111101111010011101111111111111111100000010001101111111111111111100000111000001111111111111111000110111000011111111111111111101011111111101111111111111111111111111111111111111111111111111111111111111111111111111110000100100111011011010000111010010101001101111010111010111010010011111010101111000000100001011110100010011010010101000011011111000111000101101100001001100000001110001100110100101010111110011011010111101001111010011100011111011000000100101100010011011010110000010010011101101101000011101001010100110111101011101001101001001111110101000011111100000101001010010110010110101011100010000011111100001110100000011001010111000100111001010111101011111001101011010110100011101001110001111111101000010010110001001101111011001001001011110110110100010001011010101101011110101110110001011011000000101011110000011100000100111110100110100101010110001001001110010001011011011101100110011100011011001101011110100010100110101101111010001110011100000111111110000001001010100101110100101100000100100001011010010010111010010101000010000101000100111010010011100101010000111110100001010010100111001111000011011000100000111001000100101111110110010101110001101100010101111010111110011010110111101000101010011100011111000010101110011100010011011010001111101101101101101101000011110100000001101111101011101011111001001001111010111100000010110101001000001001101001010101010010000100100100010110110111000001010011000110110011010111110100000111101011011110100011100110001001111111100000010010110000011101101011000001001001110110110110001110100101001101100001000000101110100100100001010100001110001000010100110101110011110011010110001000011110010111011001011101100101000100011111001101011110101111110110100001111010001110100111001111110010000001001011000100111001010100000100100111011011010111001110010101001101111010111011101010010011111010101111000000000001010010100010011010010101001000100000001001000101101101001010010101000001101100110101000101011110101010110111101000101001100111101111111000000100101100001101011010110000010010011110010100000011101001010100001000111011101011101001001111010010111100000010000101001010011101101001010101100010000011100100010110110111011001010111000110110011010111101011111001101011011110110011101001110001111111100000000010110001001101101011000001011001110110110100001110100101000011011110101110101110100100101110101011110000001000010100111000100110100101010110001000011110010001011011011101100101001100011011001101011110101111110110101101111010001110100111010111111110000001001011000100100110101100000100110111011011000000111010010101110010000101001010111010010011000101010000110000100001010010111011001111001101011000100000101101000011111101110110010101000001101110110101111010111110101010110001101000111010011100000111110101000100101100010011000101001100010010011101101101000100011101010100110111101011101010111001001111101010100100000010000101001010001001110101010101100010000011100100001001010111011001010111000110100100101111101001111001101011011110111100010111110001111111100000011101001111001101101011000001110100100001110100001110111010110011011110101110101110111001111110101011110000001000001100101000100110100101010110001000001110010001001011011101100101011100011011011101011110101111100110101101101010001110100111000111111110010001001011000100110110101100010100100111011011010000111010000101001101111010111010111010000011111010101111000000100001000010100010011010010101011000110000111001000101101101110110000101110001101100110101111010101110011010110111101000111010001100011111111001111011011100010011011010110111101101100101101101000011100111110001101011101011101011100100001111101100111100000010011101001010001111101001010101110010000011100110010110110111000001010111000000110011010111100011111001101110011110100011110111110001110111100000010010110110001101011111000001001001110110110100001110100101010011011110101110101110100100111110101010001111101000010100101000100001011010101110001000001110011110001110100001100101011100000010001101011000101111100110111001111010001000100111000111100110000001001001000100110110100000000100101001011011010000110101101010110100111010111010111101101100000110101111000000100001101101100010011010010101011000100000111001000101101101110110010010000001101100110101111010110001100110110111101000111010000001000011111000000100101100000111011100110000010010011101011101000001101001010100110111111011101101101001001111110010100100001110000101001010010110010110101011100010000011111011101001001011011001010111000111110111010001101011111001101011011110100011101001110001111111100000010010110001001101111011000001001011110110110100011110100101010001011110101110110110100100111100101011110000010111101011010110100110100101001001110111110000010001011011011101100101011110011011001101011110101111100100001101111010001110100111000111111110000001001011000100110110101100000100100111011011010000111010010101001101001010111100111010010011111010010000111110100001010010100010000111100011011000100000111001010001101111110110010101110001011100110101111010111110011010000111101000111010011100011111001000000110101100010011011010101111101100011101101101000011101110101010110111101011101011101001001101101010111100000010000101001010001001101001010101100010000011100100010110110111011001010111000110110011010111101011111010001011011110100011100110101110001111100000010010101110110000111011000001001001010010011000011110100101010011101110010010111110100100111110111011011100011000010100101000111001001011000110001000001110001110011101101101100101011100100010001010111110101111100110111001111011001110100111000111111110000001001011000100110110101100000100100111011010010000111010010101101101111011011010111010010010011010101111111111010110101101110010011010010001000101100100111001000101101101111010010101110001101100110101111010111110011010110111101000111010011100011111111000000100101100010011011010110</div></div><div>长度为7200，尝试转为黑白图像：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>from PIL import Image</div><div><br/></div><div>a = open('C:/Users/Administrator/Desktop/1.txt', 'r').read()</div><div>w = 30</div><div>h = 240</div><div><br/></div><div>img = Image.new('RGB', (w, h))</div><div>for i in range(w):</div><div>    for j in range(h):</div><div>        k = i + j * w</div><div>        if a[k] == '0':</div><div>            img.putpixel((i, j), (0, 0, 0))</div><div>        elif a[k] == '1':</div><div>            img.putpixel((i, j), (255, 255, 255))</div><div>img.show()</div></div><div><img src="攻防世界高手区12（91-96）_files/1.png" type="image/png" data-filename="1.png"/></div><div>看到了flag但后半仍然是乱码。回头看看还有没有尚未利用的线索，应该就是pyc文件了。</div><div>加上文件头03 F3 0D 0A，然后用uncompyle6反编译。</div><div><img src="攻防世界高手区12（91-96）_files/Image [12].png" type="image/png" data-filename="Image.png"/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>C:\Users\Administrator\Desktop&gt;uncompyle6 HaGePiA.pyc &gt; 1.py</div></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div># uncompyle6 version 3.7.3</div><div># Python bytecode 2.7 (62211)</div><div># Decompiled from: Python 3.7.5 (tags/v3.7.5:5c02a39a0b, Oct 15 2019, 00:11:34) [MSC v.1916 64 bit (AMD64)]</div><div># Embedded file name: Fl4g.py</div><div># Compiled at: 2017-07-02 00:15:33</div><div>from os import urandom</div><div><br/></div><div>def generate(m, k):</div><div>    result = 0</div><div>    for i in bin(m ^ k)[2:]:</div><div>        result = result &lt;&lt; 1</div><div>        if int(i):</div><div>            result = result ^ m ^ k</div><div>        if result &gt;&gt; 256:</div><div>            result = result ^ P</div><div>    return result</div><div><br/></div><div>def encrypt(seed):</div><div>    key = int(urandom(32).encode('hex'), 16)</div><div>    while True:</div><div>        yield key</div><div>        key = generate(key, seed) + 233333333333</div><div><br/></div><div>def convert(string):</div><div>    return int(string.encode('hex'), 16)</div><div><br/></div><div>P = 115792089237316195423570985008687907853269984665640564039457584007913129640997</div><div>flag1 = 'ThIs_Fl4g_Is_Ri9ht'</div><div>flag2 = 'Hey_Fl4g_Is_Not_HeRe'</div><div>key = int(urandom(32).encode('hex'), 16)</div><div>data = open('data.txt', 'r').read()</div><div>result = encrypt(key)</div><div>encrypt1 = bin(int(data, 2) ^ eval('0x' + hex(result.next())[2:-1] * 22))[2:]</div><div>encrypt2 = hex(convert(flag1) ^ result.next())[2:-1]</div><div>encrypt3 = hex(convert(flag2) ^ result.next())[2:-1]</div><div>print 'flag1:', encrypt2</div><div>print 'flag2:', encrypt3</div><div>f = open('encrypt.txt', 'w')</div><div>f.write(encrypt1)</div><div>f.close()</div><div># okay decompiling HaGePiA.pyc</div></div><div><br/></div><div>简而言之，代码对三段flag使用同一个seed进行了OTP（One Time Password，单次有效密码）加密。其中encrypt2和3的明文（flag1、flag2）和密文（在zip压缩包的注释里）已知，encrypt1的密文（base32隐写解密出来的二进制）已知。跑个脚本把encrypt1的明文解出来<span style="color: rgb(255, 0, 0); font-weight: bold;">（脚本是抄的）</span>：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div># Python2</div><div>def generate(m, k):</div><div>    result = 0</div><div>    for i in bin(m ^ k)[2:]:</div><div>        result = result &lt;&lt; 1</div><div>        if int(i):</div><div>            result = result ^ m ^ k</div><div>        if result &gt;&gt; 256:</div><div>            result = result ^ P</div><div>    return result</div><div>       </div><div>def convert(string):</div><div>    return int(string.encode('hex'), 16)</div><div>    </div><div># P = 115792089237316195423570985008687907853269984665640564039457584007913129640997L</div><div>P = 0x10000000000000000000000000000000000000000000000000000000000000425L</div><div>flag1 = 'ThIs_Fl4g_Is_Ri9ht'</div><div>flag2 = 'Hey_Fl4g_Is_Not_HeRe'</div><div>encrypt1 = open('1.txt', 'r').read()</div><div>encrypt2 = 0xec8d57d820ad8c586e4be0122b442c871a3d71cd8036c45083d860caf1793ddc</div><div>encrypt3 = 0xc40a0be335babcfbd8c47aa771f6a2ceca2c8638caa5924da58286d2a942697e</div><div><br/></div><div>key3 = encrypt3 ^ convert(flag2)</div><div>key2 = encrypt2 ^ convert(flag1)</div><div>print 'Found key2:',key2</div><div>print 'Found key3:',key3</div><div>tmp = key3 - 233333333333L</div><div><br/></div><div>for i in range(0,255):</div><div>    tmp = generate(tmp,0)</div><div>seed = tmp ^ key2</div><div>print 'Found seed:',seed</div><div>print 'use seed generate key3:',generate(key2,seed)+233333333333L</div><div>tmp = key2 - 233333333333L</div><div>for i in range(0,255):</div><div>    tmp = generate(tmp,0)</div><div>key1 = tmp ^ seed</div><div>print 'Found key1:',key1</div><div>print 'use key1 generate key2:',generate(key1,seed)+233333333333L</div><div>result = eval(hex(int(encrypt1,2))[:-1]) ^ eval('0x'+hex(key1)[2:-1]*22)</div><div>data = open('data.txt', 'w')</div><div>data.write(bin(result)[2:])</div><div>data.close()</div></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>C:\Users\Administrator\Desktop&gt;python2 2.py</div><div>Found key2: 106995563980506657662077029892322963264403881417159712672564928475427049067944</div><div>Found key3: 88671068837744075209433210341816292978555400513685101738053716863426000010011</div><div>Found seed: 5544394661204742634042801175162170575677663817397376241276862163453923491679</div><div>use seed generate key3: 88671068837744075209433210341816292978555400513685101738053716863426000010011</div><div>Found key1: 111616308696395276929321413298017278602171507238416551112252129476986249271593</div><div>use key1 generate key2: 106995563980506657662077029892322963264403881417159712672564928475427049067944</div></div><div>输出解密结果为data.txt，再用之前作图脚本生成图像：</div><div><img src="攻防世界高手区12（91-96）_files/1 [1].png" type="image/png" data-filename="1.png"/></div><div><br/></div><div>flag：flag{H4pPy_pY_C0dlng}</div><div><br/></div><div><span style="font-weight: bold;">096 the_golden_gate</span></div><div><span style="color: rgb(255, 0, 0);">原题：We've found an encoder board along with cipher text. Please help us to decrypt it.</span></div><div><span style="color: rgb(255, 0, 0);">The cipher text: BQDykmgZ0I6SaQnq4o/iEONudetXdPJdpl1UVSlU69oZOtvqnHfinOpcEfIjXy9okkVpsuw2kpKS==</span></div><div><span style="color: rgb(255, 0, 0);">（XCTF没有给这段密文，只给了加密用的电路板图片……）</span></div><div><br/></div><div>下载得到一堆电路板的照片。用意是通过电路板解析出加密流程，然后反向解密密文。电路板上共有8个按钮和8个LED灯，猜测按钮用于输入明文（共8位0和1，正好是1字节二进制数），LED输出密文（同样是1字节二进制数）。观察电路板可以发现，在按钮和LED之间连接的电路总共构成8个异或门：</div><div><img src="攻防世界高手区12（91-96）_files/Image [13].png" type="image/png" data-filename="Image.png"/></div><div>再根据电路的连接（参考<a href="https://github.com/ctfs/write-ups-2014/tree/master/seccon-ctf-2014/the-golden-gate">Writeup</a>）可以得到LED是哪些按钮异或的结果。记按钮为B，LED为L：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>L1 = B1 XOR B6 XOR B8</div><div>L2 = B3 XOR 1 XOR B3 XOR B2 = NOT B2</div><div>L3 = B3 XOR 1 = NOT B3</div><div>L4 = B2 XOR B3 XOR B6 XOR B8</div><div>L5 = B2 XOR B7</div><div>L6 = B2 XOR B4 XOR B6</div><div>L7 = B2 XOR B4</div><div>L8 = B2 XOR B3 XOR B5</div></div><div>逆推得到从密文（LED）到明文（按钮）的解码算法：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>B1 = B6 XOR B8 XOR L1</div><div>B2 = NOT L2</div><div>B3 = NOT L3</div><div>B4 = B2 XOR L7</div><div>B5 = (B2 XOR B3) XOR L8</div><div>B6 = (B2 XOR B4) XOR L6</div><div>B7 = B2 XOR L5</div><div>B8 = B2 XOR B3 XOR B6 XOR L4</div></div><div>另一方面，注意到电路板中的上拉输入和下拉输入，在解密前，需要反转每个LED的值，解密后，需要反转1、2、5、7四个按钮的值。从而可以写出解密函数：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>def nott(i):</div><div>    if i != 0 and i != 1:</div><div>        return None</div><div>    else:</div><div>        return (i + 1) % 2</div><div><br/></div><div>def decrypt(led):</div><div>    temp = str(bin(led))[2:].zfill(8)</div><div>    led = [None] * 8</div><div>    for i in range(8):</div><div>        led[i] = nott(int(temp[i]))</div><div>    button = [None] * 8</div><div>    button[1] = nott(led[1])</div><div>    button[2] = nott(led[2])</div><div>    button[3] = button[1] ^ led[6]</div><div>    button[4] = button[1] ^ button[2] ^ led[7]</div><div>    button[5] = button[1] ^ button[3] ^ led[5]</div><div>    button[6] = button[1] ^ led[4]</div><div>    button[7] = button[1] ^ button[2] ^ button[5] ^ led[3]</div><div>    button[0] = button[5] ^ button[7] ^ led[0]</div><div>    for i in [0, 1, 4, 6]:</div><div>        button[i] = nott(button[i])</div><div>    res = ''</div><div>    for i in range(8):</div><div>        res += str(button[i])</div><div>    return res</div></div><div>接下来就可以对密文进行解密，但注意到按钮和led构成字节的方向是不明确的。尝试后发现，如果把按钮和led都视为按从8到1的顺序构成字节，解密之后可以得到有效信息：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>import base64</div><div>cipher = 'BQDykmgZ0I6SaQnq4o/iEONudetXdPJdpl1UVSlU69oZOtvqnHfinOpcEfIjXy9okkVpsuw2kpKS=='</div><div><br/></div><div>c = base64.b64decode(cipher)</div><div>for i in range(len(c)):</div><div>    n = str(bin(c[i]))[2:].zfill(8)</div><div>    n = list(n)[::-1]</div><div>    d = decrypt(n)</div><div>    d = list(d)[::-1]</div><div>    r = ''.join(d)</div><div>    r = int(r, 2)</div><div>    print(str(hex(r))[2:].zfill(2), end = '')</div></div><div>输出：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>1f8b0800024b735400030bc9485548cb494c57c82c5608767576f6f7abf6c8294b3128c9cf8c48cfc977ca08f1ade50200b703a08725000000</div></div><div>很明显1F 8B是gzip格式压缩包的文件头，用十六进制编辑器将其保存为gz格式文件。解压得到文本：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>The flag is SECCON{Hlvd0toiXgloBhTM}</div></div><div><br/></div><div>flag：SECCON{Hlvd0toiXgloBhTM}</div></span>
</div></body></html> 