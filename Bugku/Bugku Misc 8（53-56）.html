<html>
<head>
  <title>Bugku Misc 8（53-56）</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/605894 (zh-CN, DDL); Windows/6.1.1 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="2712"/>
<h1>Bugku Misc 8（53-56）</h1>
<h2><a href="https://DemonStarAlgol.github.io/Misc/">[无关链接]</a></h2>

<div>
<span><div><span style="font-weight: bold;">53 贝氏六十四卦</span></div><div><br/></div><div>下载得到png格式文件。Stegsolve查看，在R/G/B plane 0可以明显看到最上方有LSB隐写痕迹：</div><div><img src="Bugku Misc 8（53-56）_files/Image.png" type="image/png" data-filename="Image.png"/></div><div>用Data Extract功能提取隐写信息：</div><div><img src="Bugku Misc 8（53-56）_files/Image [1].png" type="image/png" data-filename="Image.png"/></div><div>可以看到明显的PNG格式文件头，Save Bin提取后手动分离或用binwalk/foremost分离，得到图片（已放大）：</div><div><img src="Bugku Misc 8（53-56）_files/Image [2].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>观察这一图片的特征：大小为48x48像素，仅由黑白两色像素组成，可能携带了某种二进制信息，特别是注意到白色像素点仅出现在8条2像素宽的竖条范围内。联想到题目名称以及最初的图片“六十四卦生自两仪”，以及Bugku给出的提示“阳爻和阴爻”，可以联想到解码方法应该与六十四卦和阳爻、阴爻有关。</div><div>查询可知，六十四卦的卦象是由六个阳爻或阴爻组成的：</div><div><img src="Bugku Misc 8（53-56）_files/Image [3].png" type="image/png" data-filename="Image.png"/></div><div>阴爻是中间断开的横线，联想到上面图中的白色像素部分，正好也处在每个6像素宽度竖条的中间。进一步可以发现可以把每6x6的小方块看作一个卦象，整张图片拆分成8x8=64个卦象。每个卦象中，阳爻代表1，阴爻代表0，共计对应6个bit。<span style="font-size: unset; color: unset; font-family: unset;">同时题目中还有提示“贝氏六十四”，联想到base64，其原理是密文中的每个字符代表6个bit，还原到明文时则是每8个bit对应一个字符。这里的解码方式也有相通之处，即每个卦象对应6个bit，全部连接后再每8个bit转码成一个字符。</span></div><div><span style="font-size: unset;"><br/></span></div><div>整理一下：</div><div>首先以6x6的小方块为单位，共8x8=64个小方块。读取每个小方块里的6行，根据第3或4个像素点的颜色，黑色转为1，白色转为0，得到384bit的二进制数字串。拼接后再每8个数字对应进行ASCII转码即得到结果。读取顺序方面，小方块之间有行优先或列优先两种可能性，单个小方块内的行也有从上至下和从下至上两种可能性，共四种可能性，可以通过转码结果判断。最终确定为小方块之间按行优先读取，小方块内部从上至下读取，脚本为：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>from PIL import Image</div><div><br/></div><div>img = Image.open('C:/Users/Administrator/Desktop/1.png')</div><div><br/></div><div>def check(x, y):</div><div>    p = img.getpixel((x, y))</div><div>    if p == 0:</div><div>        return '1'</div><div>    if p == 255:</div><div>        return '0'</div><div><br/></div><div>res = ''</div><div>for y in range(8):</div><div>    for x in range(8):</div><div>        for l in range(6):</div><div>            res += check(6*x+2, 6*y+l)</div><div>print(res)</div></div><div>输出结果：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>010110100110110101111000011010000101101000110011011101000101001001100001010101110100011001110101010110000011000001110100001100010110001001101100001110010101010101100100010101110011010101100110010101000101011101010110011101010101101000110001001110010101100101100100010101100011100101010100011000100011001000110101011011100101100000110001010011100110111101100001010110000011000000111101</div></div><div>每八位二进制转码：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>ZmxhZ3tRaWFuX0t1bl9UdW5fTWVuZ19YdV9Tb25nX1NoaX0=</div></div><div>最后base64转码：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>flag{Qian_Kun_Tun_Meng_Xu_Song_Shi}</div></div><div><br/></div><div>此外，也有另一种将每个6x6小方块对应到一个字符的转码方法，得到的结果经过一次base64转码后与上述方法得到的结果相同。如果从base64编码算法的角度来分析，会发现这两种转码方法的实质是完全相同的（后一种相当于手动对数据多进行了一次base64编码），因此两种方法都可以算是预期解。</div><div><br/></div><div>flag：flag{Qian_Kun_Tun_Meng_Xu_Song_Shi}</div><div><br/></div><div><span style="font-weight: bold;">54 三色绘恋</span></div><div><br/></div><div>下载得到jpg格式文件，十六进制编辑器查看，文件尾后有额外数据：</div><div><img src="Bugku Misc 8（53-56）_files/Image [4].png" type="image/png" data-filename="Image.png"/></div><div>提取得到zip格式压缩包，内含加密的flag.txt：</div><div><img src="Bugku Misc 8（53-56）_files/Image [5].png" type="image/png" data-filename="Image.png"/></div><div>观察图片，从内容可以猜到原始图片下方还有内容，通过Google图片搜索或查看缩略图也可以确认这一点：</div><div><img src="Bugku Misc 8（53-56）_files/Image [6].png" type="image/png" data-filename="Image.png"/></div><div><img src="Bugku Misc 8（53-56）_files/Image [7].png" type="image/png" data-filename="Image.png"/></div><div>借助010Editor的模板功能，将图片高度改大：</div><div><img src="Bugku Misc 8（53-56）_files/Image [8].png" type="image/png" data-filename="Image.png"/></div><div>得到图片：</div><div><img src="Bugku Misc 8（53-56）_files/Image [9].png" type="image/png" data-filename="Image.png"/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>key is a56v1sa6fc</div></div><div>解压得到flag。</div><div><br/></div><div>flag：fLag{M0_XIa0_Ju_T1an_XIa_Dl_1!}</div><div><br/></div><div><span style="font-weight: bold;">55 爱因斯坦yyds</span></div><div><br/></div><div>下载得到jpg格式文件，十六进制编辑器查看，文件尾部有额外数据：</div><div><img src="Bugku Misc 8（53-56）_files/Image [10].png" type="image/png" data-filename="Image.png"/></div><div>提取得到7z格式加密压缩包，需要寻找密码。<span style="font-size: unset; color: unset; font-family: unset;">查看图片exif信息：</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>root@kali:~/Desktop# exiftool file.jpg</div><div>ExifTool Version Number         : 11.98</div><div>File Name                       : file.jpg</div><div>Directory                       : .</div><div>File Size                       : 47 kB</div><div>File Modification Date/Time     : 2021:01:11 01:40:15+00:00</div><div>File Access Date/Time           : 2021:01:11 01:44:41+00:00</div><div>File Inode Change Date/Time     : 2021:01:11 01:44:41+00:00</div><div>File Permissions                : rwxrw-rw-</div><div>File Type                       : JPEG</div><div>File Type Extension             : jpg</div><div>MIME Type                       : image/jpeg</div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">……（中略）</span></div><div><font style="color: rgb(255, 0, 0);">Text Layer Name                 : DES_password:E=MC², JIEYAMIMA：bugku666</font></div><div><font color="#FF0000">Text Layer Text                 : DES_password:E=MC², JIEYAMIMA：bugku666</font></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">……（中略）</span></div><div>Thumbnail Image                 : (Binary data 1606 bytes, use -b option to extract)</div></div><div>得到解压密码bugku666。不过这一步可能不是预期解，问题在于Adobo Photoshop编辑图片添加文字层时自动在exif信息中添加了文字层标签。因为在十六进制下修改JPG图片的高度到1024,，同样可以找到这两段文字，方法参见其他题目的笔记，不再赘述。解压7z压缩包，得到flag.rar和密码.txt。前者同样是加密压缩包，先看后者：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>MuS4que9l+mprOeLrOijgeiAheaMh+aMpeedgOS4gOmYn+e8luWPt+S4umFiY2TnmoTln7rlm6DnqoHlj5jnmoTnvZfpqazni6zoo4HogIXmnaXmipPogIHpqazvvIzmlLvnv7vkuoY25Liq5pyJ5oqk5qCP55qE5Z+O5aKZ77yM54S25ZCO5LuW5Lus6aG65Yip55qE5oqT5Yiw5LqG6ICB6ams44CC5bm25b6X5Yiw5LiA5Liy5a2X56ym77yab2Vtc294ZXBkank</div></div><div>base64转码：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>2个罗马独裁者指挥着一队编号为abcd的基因突变的罗马独裁者来抓老马，攻翻了6个有护栏的城墙，然后他们顺利的抓到了老马。并得到一串字符：oemsoxepdjy</div></div><div>“罗马独裁者”显然是凯撒，“2个罗马独裁者”指密钥为2的移位密码。“基因突变的罗马独裁者”意为变异凯撒，结合“编号为abcd”，应该是密钥为abcd的维吉尼亚密码或Autokey密码。“6个有护栏的城墙”指分组数为6或每组字符数为6的栅栏密码。其中栅栏密码有普通栅栏密码和W形栅栏密码两种（举例来说，CaptfEncoder这一工具内置的就是W形栅栏），每一步有加密和解密两种可能性，顺序有凯撒-维吉尼亚/Autokey-栅栏或倒过来两种可能性。由于题目给出的信息不够充分，需要穷举试验，最后确定为如下步骤：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>oemsoxepdjy</div><div>密钥为2的移位密码解密：mckqmvcnbhw</div><div>密钥为abcd的维吉尼亚密码解密：mbinmuakbgu</div><div>分组数为6的W形栅栏密码解密：mimabugkunb</div></div><div>用密码bugkunb解压flag,rar得到flag.txt：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>U2FsdGVkX190Qzuyvdil3MZ9LQUzBbQaXJNzVFBzcAf5CzdvUZ5wdQ==</div></div><div>从开头U2Fs可以看出这是一段base64形式的AES/DES/Rabbit...等密码的密文。结合之前从exif信息中得到的DES密码，以及从W形栅栏密码可以判断出题人使用了CaptfEncoder工具。同样使用CaptfEncoder中的DES密码和密钥E=MC²解密，得到：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>flag{BugKu_NB_666}</div></div><div><br/></div><div>flag：flag{BugKu_NB_666}</div><div><br/></div><div><span style="font-weight: bold;">56 被勒索了</span></div><div>题目描述：全盘所有文件都被加密了，检查文件的时候发现了火绒的数据目录没有被加密，不知道能不能发现什么线索</div><div><br/></div><div>下载得到zip格式文件，解压得到Sysdiag文件夹，搜索发现这是火绒安全软件的文件名。记录文件夹内的文件结构：</div><div><img src="Bugku Misc 8（53-56）_files/Image [11].png" type="image/png" data-filename="Image.png"/></div><div>在Windows虚拟机里安装火绒安全软件后全盘搜索以上文件名，找到%programdata%目录下的/Huorong/Sysdiag文件夹：</div><div><img src="Bugku Misc 8（53-56）_files/Image [12].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>所以接下来的问题就是怎么把压缩包里的Sysdiag文件夹替换进去。我的操作步骤如下：</div><div>1、卸载火绒安全软件，重启虚拟机；</div><div>2、将压缩包中的Sysdiag文件夹解压到%programdata%/Huorong/目录下，并设置属性为只读；</div><div>3、重新安装火绒安全软件，会提示安全服务异常：</div><div><img src="Bugku Misc 8（53-56）_files/Image [13].png" type="image/png" data-filename="Image.png"/></div><div>4、不用管它，把%programdata%/Huorong/目录的只读取消，再进入火绒安全软件的隔离区：</div><div><img src="Bugku Misc 8（53-56）_files/Image [14].png" type="image/png" data-filename="Image.png"/></div><div>5、将flag.txt恢复至任意文件夹：</div><div><img src="Bugku Misc 8（53-56）_files/Image [15].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>flag：flag{Virus_traceability}</div></span>
</div></body></html> 